openapi: 3.0.3
info:
  title: Product Scanner API
  description: |
    상품 정보 스캔 및 업데이트 워크플로우 API

    ## 지원 플랫폼
    | 플랫폼 | 스캔 방식 | URL 패턴 |
    |--------|----------|----------|
    | hwahae | HTTP API | hwahae.co.kr |
    | musinsa | HTTP API | musinsa.com |
    | zigzag | GraphQL | zigzag.kr |
    | oliveyoung | Playwright | oliveyoung.co.kr |
    | kurly | Playwright | kurly.com |
    | ably | Playwright | a-bly.com |

    ## 워크플로우 종류
    - **Platform Update**: 플랫폼별 대량 상품 업데이트 (스케줄러 사용)
    - **Platform Validation**: 플랫폼별 대량 상품 검증 (업데이트 없음)
    - **Extract ProductSet**: 개별 ProductSet ID 기반 추출
    - **Extract URL**: URL 기반 단일 상품 추출

  version: 2.0.0
  contact:
    name: Scoob Scraper Team

servers:
  - url: http://localhost:3989
    description: 로컬 개발 서버
  - url: http://product_scanner:3000
    description: Docker 내부 통신

tags:
  - name: Health
    description: 서버 상태 확인
  - name: Products
    description: 상품 추출 (동기 API)
  - name: Search
    description: 상품 검색 API (단일 플랫폼 비동기 + 통합 검색 동기)
  - name: Workflows
    description: 워크플로우 실행 및 조회 (비동기 Job)
  - name: Jobs
    description: 실행 중인 Job 모니터링
  - name: Workers
    description: Worker 컨테이너 관리 (재시작, 상태 조회)
  - name: Scheduler
    description: 자동 스케줄러 제어
  - name: Alert Watcher
    description: 테이블 모니터링 및 Slack 알림 서비스

paths:
  /health:
    get:
      tags: [Health]
      summary: 서버 상태 확인
      description: 서버 및 플랫폼 설정 로드 상태 확인
      responses:
        '200':
          description: 정상
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                message: Product Scanner is running
                version: 1.0.0
                architecture: API v1 with Platform Routing
                platforms:
                  loaded: true
                  count: 6
        '503':
          description: 서비스 장애 (플랫폼 설정 로드 실패)

  /api/v2/products/extract-by-product-set:
    post:
      tags: [Products]
      summary: ProductSet ID 기반 상품 추출
      description: |
        Supabase의 product_sets 테이블에서 ProductSet을 조회하고 상품 정보를 추출합니다.

        **동기 API** - 결과를 즉시 반환합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [productSetId]
              properties:
                productSetId:
                  type: string
                  format: uuid
                  description: ProductSet UUID
            example:
              productSetId: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: 추출 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractResponse'
        '400':
          description: 잘못된 요청 (UUID 형식 오류)
        '404':
          description: ProductSet을 찾을 수 없음

  /api/v2/products/extract-by-url:
    post:
      tags: [Products]
      summary: URL 기반 상품 추출
      description: |
        URL에서 플랫폼을 자동 감지하고 상품 정보를 추출합니다.

        **동기 API** - 결과를 즉시 반환합니다.
        - Supabase 조회 없음 (db: null, comparison: null)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
                  format: uri
                  description: 상품 URL
            examples:
              oliveyoung:
                summary: 올리브영 상품
                value:
                  url: "https://www.oliveyoung.co.kr/store/goods/getGoodsDetail.do?goodsNo=A000000231822"
              hwahae:
                summary: 화해 상품
                value:
                  url: "https://www.hwahae.co.kr/goods/101579"
              zigzag:
                summary: 지그재그 상품
                value:
                  url: "https://zigzag.kr/catalog/products/135549633"
      responses:
        '200':
          description: 추출 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractResponse'
        '400':
          description: 잘못된 URL 또는 지원하지 않는 플랫폼

  # ============================================================================
  # Search API - 상품 검색
  # ============================================================================

  /api/v2/search/unified:
    post:
      tags: [Search]
      summary: 6개 플랫폼 통합 검색 (동기)
      description: |
        6개 플랫폼을 **병렬로** 검색하고 결과를 즉시 반환합니다.

        **동기 API** - 결과를 즉시 반환합니다 (7~15초 소요).

        ## 특징
        - 병렬 검색: Promise.allSettled로 6개 플랫폼 동시 검색
        - 격리 실행: 각 플랫폼 독립 브라우저 (한 플랫폼 실패가 다른 플랫폼에 영향 없음)
        - Mutex Queue: 동시 1개 요청만 처리 (리소스 보호)
        - 결과 저장: JSONL 파일로 자동 저장

        ## 추천 상품 필터링
        검색 결과가 없을 때(totalCount=0) 추천 상품이 반환되는 문제를 필터링:
        - **Ably**: totalCount=0이면 빈 배열 반환
        - **Kurly**: totalCount=0이면 빈 배열 반환

        ## URL 정규화
        모든 플랫폼에서 정규화된 URL 형식으로 반환:
        | 플랫폼 | URL 형식 |
        |--------|----------|
        | oliveyoung | `https://www.oliveyoung.co.kr/store/goods/getGoodsDetail.do?goodsNo={id}` |
        | hwahae | `https://www.hwahae.co.kr/goods/{id}` |
        | musinsa | `https://www.musinsa.com/products/{id}` |
        | ably | `https://m.a-bly.com/goods/{id}` |
        | kurly | `https://www.kurly.com/goods/{id}` |
        | zigzag | `https://zigzag.kr/catalog/products/{id}` |

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnifiedSearchRequest'
            examples:
              cosmetic:
                summary: 화장품 검색
                value:
                  brand: "라네즈"
                  productName: "워터뱅크 크림"
                  maxPerPlatform: 5
              simple:
                summary: 브랜드만 검색
                value:
                  brand: "토리든"
                  maxPerPlatform: 3
      responses:
        '200':
          description: 통합 검색 결과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnifiedSearchResponse'
              example:
                success: true
                data:
                  jobId: "019afc73-69e8-704c-bf8b-66050d3d1838"
                  keyword: "라네즈 워터뱅크 크림"
                  brand: "라네즈"
                  productName: "워터뱅크 크림"
                  maxPerPlatform: 5
                  platforms:
                    - platform: zigzag
                      success: true
                      products:
                        - productName: "워터뱅크 블루 히알루로닉 크림"
                          thumbnail: "https://cf.product-image.s.zigzag.kr/..."
                          productUrl: "https://zigzag.kr/catalog/products/165340832"
                          platform: zigzag
                      totalCount: 15
                      durationMs: 832
                    - platform: oliveyoung
                      success: true
                      products: []
                      totalCount: 0
                      durationMs: 8417
                  summary:
                    totalPlatforms: 6
                    successPlatforms: 6
                    failedPlatforms: 0
                    totalProducts: 12
                    durationMs: 8461
                  resultFilePath: "/app/results/2025-12-08/job_search_019afc73-69e8-704c-bf8b-66050d3d1838.jsonl"
        '400':
          description: 잘못된 요청
          content:
            application/json:
              example:
                success: false
                error: "Bad Request"
                message: "brand is required"

  /api/v2/search/unified/status:
    get:
      tags: [Search]
      summary: 통합 검색 큐 상태
      description: Mutex 기반 통합 검색 큐의 현재 상태를 조회합니다.
      responses:
        '200':
          description: 큐 상태
          content:
            application/json:
              example:
                success: true
                data:
                  is_processing: false
                  waiting_count: 0

  /api/v2/search/filter-products:
    post:
      tags: [Search]
      summary: LLM 기반 상품 유효성 필터링
      description: |
        검색 결과에서 **본품에 해당하는 상품만** 필터링합니다.

        **동기 API** - 결과를 즉시 반환합니다 (1~3초 소요).

        ## 필터링 기준
        - ✅ **유효**: 타겟 상품이 본품(메인)인 경우
        - ❌ **제외**: 구성품, 증정품, 다른 상품이 주가 되는 세트

        ## 예시
        타겟: "토리든 다이브인 저분자 히알루론산 세럼"

        | 상품명 | 판정 | 이유 |
        |--------|------|------|
        | 토리든 다이브인 저분자 히알루론산 세럼 50ml | ✅ | 본품 |
        | 토리든 다이브인 저분자 히알루론산 세럼 100ml 기획 | ✅ | 본품 (용량/기획 다름) |
        | 토리든 다이브인 저분자 히알루론산 **멀티패드** 80매 | ❌ | 다른 상품 |
        | 토리든 **밸런스풀 시카** 컨트롤 세럼 50ml | ❌ | 다른 라인 상품 |

        ## LLM 비용
        - 모델: gemini-2.5-flash
        - 평균 비용: ~$0.0003/요청 (약 ₩0.4)
        - 비용 로그: `results/{date}/llm_cost__{date}.jsonl`

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FilterProductsRequest'
            examples:
              basic:
                summary: 기본 사용
                value:
                  brand: "토리든"
                  product_name: "다이브인 저분자 히알루론산 세럼"
                  product_names:
                    oliveyoung:
                      - "[1등세럼] 토리든 다이브인 저분자 히알루론산 세럼 50ml"
                      - "[NEW] 토리든 밸런스풀 시카 컨트롤 세럼 50ml"
                    zigzag:
                      - "토리든 다이브인 저분자 히알루론산 세럼 50ml"
                      - "토리든 다이브인 저분자 히알루론산 멀티패드 80매"
      responses:
        '200':
          description: 필터링 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FilterProductsResponse'
              examples:
                success:
                  summary: 성공 응답
                  value:
                    success: true
                    data:
                      brand: "토리든"
                      product_name: "다이브인 저분자 히알루론산 세럼"
                      platforms:
                        - platform: "oliveyoung"
                          valid_indices: [0]
                        - platform: "zigzag"
                          valid_indices: [0]
                      usage:
                        input_tokens: 1926
                        output_tokens: 41
                        total_tokens: 1967
                        cost_usd: 0.000313
                      durationMs: 1314
        '400':
          description: 잘못된 요청
          content:
            application/json:
              example:
                success: false
                error:
                  code: "VALIDATION_ERROR"
                  message: "brand is required"
                data:
                  platforms: []
        '500':
          description: LLM API 오류
          content:
            application/json:
              examples:
                rate_limit:
                  summary: Rate Limit 초과
                  value:
                    success: false
                    error:
                      code: "RATE_LIMIT_EXCEEDED"
                      message: "Gemini API rate limit exceeded"
                    data:
                      platforms: []
                internal:
                  summary: 내부 오류
                  value:
                    success: false
                    error:
                      code: "INTERNAL_ERROR"
                      message: "Gemini API internal error"
                    data:
                      platforms: []

  /api/v2/workflows/execute:
    post:
      tags: [Workflows]
      summary: 워크플로우 실행
      description: |
        비동기 워크플로우를 실행하고 Job ID를 반환합니다.

        **비동기 API** - Job ID로 상태를 조회해야 합니다.

        ## 사용 가능한 워크플로우

        ### Platform 워크플로우 (대량 처리)
        | workflow_id | 설명 |
        |-------------|------|
        | hwahae-update-v2 | 화해 상품 업데이트 |
        | hwahae-validation-v2 | 화해 상품 검증 (업데이트 없음) |
        | musinsa-update-v2 | 무신사 상품 업데이트 |
        | zigzag-update-v2 | 지그재그 상품 업데이트 |
        | oliveyoung-update-v2 | 올리브영 상품 업데이트 |
        | kurly-update-v2 | 컬리 상품 업데이트 |
        | ably-update-v2 | 에이블리 상품 업데이트 |

        ### Extract 워크플로우 (개별 처리)
        | workflow_id | 설명 |
        |-------------|------|
        | extract-product-set-update-v2 | ProductSet ID 기반 추출 + 업데이트 |
        | extract-product-set-validation-v2 | ProductSet ID 기반 검증 |
        | extract-url-validation-v2 | URL 기반 추출 |

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkflowExecuteRequest'
            examples:
              platform_update:
                summary: 플랫폼 업데이트 워크플로우
                value:
                  workflow_id: hwahae-update-v2
                  priority: 5
                  params:
                    platform: hwahae
                    link_url_pattern: hwahae.co.kr
                    sale_status: on_sale
                    limit: 100
                    batch_size: 10
                    concurrency: 1
                    wait_time_ms: 2500
                    update_sale_status: true
                  metadata:
                    description: "화해 on_sale 상품 업데이트"
              product_set_update:
                summary: ProductSet 업데이트 워크플로우
                value:
                  workflow_id: extract-product-set-update-v2
                  priority: 5
                  params:
                    product_set_id: "550e8400-e29b-41d4-a716-446655440000"
                    update_sale_status: true
                  metadata:
                    description: "ProductSet 개별 업데이트"
              url_validation:
                summary: URL 검증 워크플로우
                value:
                  workflow_id: extract-url-validation-v2
                  priority: 5
                  params:
                    url: "https://www.oliveyoung.co.kr/store/goods/getGoodsDetail.do?goodsNo=A000000231822"
                  metadata:
                    description: "URL 기반 상품 추출"
      responses:
        '202':
          description: 워크플로우 실행 시작됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowExecuteResponse'
              example:
                success: true
                job_id: "01934567-89ab-7def-0123-456789abcdef"
                message: Workflow execution started
        '400':
          description: 잘못된 요청

  /api/v2/workflows/jobs/{jobId}:
    get:
      tags: [Workflows]
      summary: Job 상태 조회
      description: 실행 중이거나 완료된 Job의 상태를 조회합니다.
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Job UUID
      responses:
        '200':
          description: Job 상태
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobStatusResponse'
        '404':
          description: Job을 찾을 수 없음

  /api/v2/workflows:
    get:
      tags: [Workflows]
      summary: 워크플로우 목록 조회
      description: 사용 가능한 모든 워크플로우 목록을 반환합니다.
      responses:
        '200':
          description: 워크플로우 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        description:
                          type: string

  /api/v2/workflows/health:
    get:
      tags: [Workflows]
      summary: 워크플로우 서비스 상태
      responses:
        '200':
          description: 정상
        '503':
          description: 서비스 장애

  /api/v2/jobs/running:
    get:
      tags: [Jobs]
      summary: 실행 중인 Job 및 Queue 현황
      description: |
        각 플랫폼별 현재 실행 중인 Job과 대기 중인 Queue 현황을 조회합니다.

        **Shell 스크립트**: `scripts/check-running-jobs.sh`
      responses:
        '200':
          description: 실행 현황
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunningJobsResponse'
              example:
                success: true
                data:
                  running:
                    - platform: hwahae
                      job_id: "01934567-89ab-7def-0123-456789abcdef"
                      workflow_id: hwahae-update-v2
                      started_at: "2024-11-28T11:25:11.000Z"
                      elapsed_seconds: 372
                  queued:
                    musinsa: 2
                    zigzag: 1
                  summary:
                    running_count: 1
                    queued_count: 3

  /api/v2/jobs/platform/{platform}/force-release:
    post:
      tags: [Jobs]
      summary: Platform Lock 강제 해제
      description: |
        특정 플랫폼의 Lock을 강제 해제하고 실행 중인 Job을 FAILED 처리합니다.

        **주의**: 실제 Worker 프로세스는 종료되지 않습니다.
        Worker 재시작이 필요하면 `/api/v2/workers/{platform}/restart`를 사용하세요.
      parameters:
        - name: platform
          in: path
          required: true
          schema:
            type: string
            enum: [hwahae, musinsa, zigzag, oliveyoung, kurly, ably, default]
          description: 플랫폼 이름
      responses:
        '200':
          description: 강제 해제 성공
          content:
            application/json:
              example:
                success: true
                message: "Platform hwahae force released"
                data:
                  platform: hwahae
                  had_running_job: true
                  released_job:
                    job_id: "01934567-89ab-7def-0123-456789abcdef"
                    workflow_id: "hwahae-update-v2"
                    started_at: "2024-11-28T11:25:11.000Z"
                  lock_released: true
                  job_marked_failed: true

  /api/v2/workers/status:
    get:
      tags: [Workers]
      summary: 전체 Worker 상태 조회
      description: |
        모든 플랫폼 Worker의 상태를 조회합니다.
        - 실행 중인 Job 정보
        - Kill Flag 설정 여부
        - Lock 보유 여부

        **Shell 스크립트**: `scripts/worker-control.sh status`
      responses:
        '200':
          description: Worker 상태
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkerStatusResponse'
              example:
                success: true
                data:
                  workers:
                    - platform: hwahae
                      running_job:
                        job_id: "01934567-89ab-7def-0123-456789abcdef"
                        workflow_id: "hwahae-update-v2"
                        started_at: "2024-11-28T11:25:11.000Z"
                        elapsed_seconds: 372
                      kill_flag_set: false
                      lock_held: true
                    - platform: oliveyoung
                      running_job: null
                      kill_flag_set: false
                      lock_held: false
                  summary:
                    total: 7
                    running: 1
                    kill_flags_set: 0
                  checked_at: "2024-11-28T11:31:23.000Z"

  /api/v2/workers/{platform}/restart:
    post:
      tags: [Workers]
      summary: Worker 재시작 요청
      description: |
        특정 플랫폼 Worker를 재시작합니다.

        **동작 방식**:
        1. Redis에 Kill Flag 설정 (TTL 60초)
        2. 실행 중인 Job을 FAILED 상태로 변경
        3. Platform Lock 해제
        4. Worker가 5초 내에 Kill Flag 감지 → `process.exit(1)`
        5. Docker가 컨테이너 자동 재시작 (`restart: unless-stopped`)

        **Shell 스크립트**: `scripts/worker-control.sh restart <platform>`
      parameters:
        - name: platform
          in: path
          required: true
          schema:
            type: string
            enum: [hwahae, musinsa, zigzag, oliveyoung, kurly, ably, default]
          description: 플랫폼 이름
      responses:
        '200':
          description: 재시작 요청 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkerRestartResponse'
              example:
                success: true
                message: "Worker restart requested for platform: hwahae"
                data:
                  platform: hwahae
                  kill_flag_set: true
                  kill_flag_ttl_seconds: 60
                  lock_released: true
                  running_job:
                    job_id: "01934567-89ab-7def-0123-456789abcdef"
                    workflow_id: "hwahae-update-v2"
                    started_at: "2024-11-28T11:25:11.000Z"
                    marked_failed: true
                  expected_restart_within_seconds: 10
        '400':
          description: 유효하지 않은 플랫폼
          content:
            application/json:
              example:
                success: false
                error: "Invalid platform"
                message: "Platform 'invalid' is not valid. Valid platforms: hwahae, musinsa, ..."

  /api/v2/scheduler/status:
    get:
      tags: [Scheduler]
      summary: 스케줄러 상태 조회
      description: |
        자동 스케줄러의 활성화 상태, 설정, 플랫폼별 상태를 조회합니다.

        **Shell 스크립트**: `scripts/scheduler-control.sh status`
      responses:
        '200':
          description: 스케줄러 상태
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchedulerStatusResponse'

  /api/v2/scheduler/start:
    post:
      tags: [Scheduler]
      summary: 스케줄러 시작
      description: |
        자동 스케줄러를 활성화합니다.

        **Shell 스크립트**: `scripts/scheduler-control.sh start`
      responses:
        '200':
          description: 시작 성공
          content:
            application/json:
              example:
                success: true
                message: Scheduler started
                data:
                  enabled: true
                  was_enabled: false

  /api/v2/scheduler/stop:
    post:
      tags: [Scheduler]
      summary: 스케줄러 중지
      description: |
        자동 스케줄러를 비활성화합니다.

        **Shell 스크립트**: `scripts/scheduler-control.sh stop`

        `?clear_queue=true` 옵션으로 대기 중인 모든 Job을 삭제할 수 있습니다.
      parameters:
        - name: clear_queue
          in: query
          schema:
            type: string
            enum: ['true', 'false']
          description: 대기 중인 모든 Job 삭제 여부
      responses:
        '200':
          description: 중지 성공
          content:
            application/json:
              example:
                success: true
                message: "Scheduler stopped and 5 queued jobs cleared"
                data:
                  enabled: false
                  was_enabled: true
                  queue_cleared: true
                  cleared_jobs:
                    hwahae: 2
                    musinsa: 3
                  total_cleared: 5

  /api/v2/alert-watcher/status:
    get:
      tags: [Alert Watcher]
      summary: Alert Watcher 상태 조회
      description: |
        테이블 모니터링 서비스의 활성화 상태, 설정, 작업별 상태를 조회합니다.

        **감시 대상 테이블**:
        - `collabo_banners`: 콜라보 배너 상품 접근성 모니터링
        - `votes`: 투표 상품 접근성 모니터링
        - `pick_sections`: Pick Sections 상품 접근성 모니터링

        **Shell 스크립트**: `scripts/alert-watcher-control.sh status`
      responses:
        '200':
          description: Alert Watcher 상태
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AlertWatcherStatusResponse'
              example:
                success: true
                data:
                  watcher:
                    enabled: true
                    running: true
                    last_changed_at: "2025-12-01T10:00:00.000Z"
                    last_heartbeat_at: "2025-12-01T11:30:05.000Z"
                    total_jobs_executed: 42
                  config:
                    tasks:
                      - id: collabo_banner
                        name: Collabo Banner Monitor
                        interval_min: 20
                      - id: votes
                        name: Votes Monitor
                        interval_min: 20
                      - id: pick_sections
                        name: Pick Sections Monitor
                        interval_min: 20
                    check_interval_ms: 60000
                  tasks:
                    collabo_banner:
                      last_completed_at: "2025-12-01T11:20:00.000Z"
                    votes:
                      last_completed_at: "2025-12-01T11:25:00.000Z"
                    pick_sections:
                      last_completed_at: "2025-12-01T11:30:00.000Z"

  /api/v2/alert-watcher/start:
    post:
      tags: [Alert Watcher]
      summary: Alert Watcher 시작
      description: |
        테이블 모니터링 서비스를 활성화합니다.

        **Shell 스크립트**: `scripts/alert-watcher-control.sh start`

        **동작 방식**:
        1. 활성화 후 감시 작업 순차 등록 (10초 간격)
        2. 각 작업 완료 후 20분 쿨다운
        3. ALERT_SLACK_CHANNEL_ID로 결과 알림 발송
      responses:
        '200':
          description: 시작 성공
          content:
            application/json:
              example:
                success: true
                message: Alert Watcher started
                data:
                  enabled: true
                  was_enabled: false

  /api/v2/alert-watcher/stop:
    post:
      tags: [Alert Watcher]
      summary: Alert Watcher 중지
      description: |
        테이블 모니터링 서비스를 비활성화합니다.

        **Shell 스크립트**: `scripts/alert-watcher-control.sh stop`

        `?clear_queue=true` 옵션으로 대기 중인 alert Job을 삭제할 수 있습니다.
      parameters:
        - name: clear_queue
          in: query
          schema:
            type: string
            enum: ['true', 'false']
          description: 대기 중인 alert Job 삭제 여부
      responses:
        '200':
          description: 중지 성공
          content:
            application/json:
              example:
                success: true
                message: "Alert Watcher stopped and 3 queued jobs cleared"
                data:
                  enabled: false
                  was_enabled: true
                  queue_cleared: true
                  cleared_jobs: 3

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded]
        message:
          type: string
        version:
          type: string
        architecture:
          type: string
        platforms:
          type: object
          properties:
            loaded:
              type: boolean
            count:
              type: integer

    ExtractResponse:
      type: object
      properties:
        success:
          type: boolean
        product:
          type: object
          description: 추출된 상품 정보
        durationMs:
          type: integer
          description: 처리 시간 (ms)
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

    WorkflowExecuteRequest:
      type: object
      required: [workflow_id, params]
      properties:
        workflow_id:
          type: string
          description: 워크플로우 ID
        priority:
          type: integer
          default: 5
          minimum: 1
          maximum: 10
          description: 우선순위 (1=최고, 10=최저)
        params:
          type: object
          description: |
            워크플로우 파라미터

            **주요 파라미터**:
            - `limit`: 조회할 상품 수. **생략 시 전체 조회** (자동 pagination)
            - `sale_status`: 판매 상태 필터 (on_sale, off_sale)
            - `batch_size`: 배치 크기
            - `concurrency`: 동시 처리 수
        metadata:
          type: object
          description: 추가 메타데이터

    WorkflowExecuteResponse:
      type: object
      properties:
        success:
          type: boolean
        job_id:
          type: string
          format: uuid
        message:
          type: string

    JobStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            job_id:
              type: string
            workflow_id:
              type: string
            status:
              type: string
              enum: [pending, running, completed, failed]
            progress:
              type: integer
              minimum: 0
              maximum: 100
            current_node:
              type: string
            result:
              type: object
            error:
              type: string
            created_at:
              type: string
              format: date-time
            started_at:
              type: string
              format: date-time
            completed_at:
              type: string
              format: date-time

    RunningJobsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            running:
              type: array
              items:
                type: object
                properties:
                  platform:
                    type: string
                  job_id:
                    type: string
                  workflow_id:
                    type: string
                  started_at:
                    type: string
                    format: date-time
                  elapsed_seconds:
                    type: integer
            queued:
              type: object
              additionalProperties:
                type: integer
            summary:
              type: object
              properties:
                running_count:
                  type: integer
                queued_count:
                  type: integer

    SchedulerStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            scheduler:
              type: object
              properties:
                enabled:
                  type: boolean
                running:
                  type: boolean
                last_changed_at:
                  type: string
                  format: date-time
                last_heartbeat_at:
                  type: string
                  format: date-time
                total_jobs_scheduled:
                  type: integer
            config:
              type: object
              properties:
                platforms:
                  type: array
                  items:
                    type: string
                check_interval_ms:
                  type: integer
                inter_platform_delay_ms:
                  type: integer
                same_platform_cooldown_ms:
                  type: integer
                on_sale_ratio:
                  type: integer
                limit:
                  type: string
                  description: "전체 조회 (자동 pagination)"
            platforms:
              type: object
              description: 플랫폼별 상태

    WorkerStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            workers:
              type: array
              items:
                type: object
                properties:
                  platform:
                    type: string
                  running_job:
                    type: object
                    nullable: true
                    properties:
                      job_id:
                        type: string
                      workflow_id:
                        type: string
                      started_at:
                        type: string
                        format: date-time
                      elapsed_seconds:
                        type: integer
                  kill_flag_set:
                    type: boolean
                  lock_held:
                    type: boolean
            summary:
              type: object
              properties:
                total:
                  type: integer
                running:
                  type: integer
                kill_flags_set:
                  type: integer
            checked_at:
              type: string
              format: date-time

    WorkerRestartResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        data:
          type: object
          properties:
            platform:
              type: string
            kill_flag_set:
              type: boolean
            kill_flag_ttl_seconds:
              type: integer
            lock_released:
              type: boolean
            running_job:
              type: object
              nullable: true
              properties:
                job_id:
                  type: string
                workflow_id:
                  type: string
                started_at:
                  type: string
                  format: date-time
                marked_failed:
                  type: boolean
            expected_restart_within_seconds:
              type: integer

    AlertWatcherStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            watcher:
              type: object
              properties:
                enabled:
                  type: boolean
                running:
                  type: boolean
                last_changed_at:
                  type: string
                  format: date-time
                last_heartbeat_at:
                  type: string
                  format: date-time
                total_jobs_executed:
                  type: integer
            config:
              type: object
              properties:
                tasks:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: string
                      name:
                        type: string
                      interval_min:
                        type: integer
                check_interval_ms:
                  type: integer
            tasks:
              type: object
              description: 작업별 상태 (last_completed_at 등)

    # ==========================================================================
    # Search API Schemas
    # ==========================================================================

    UnifiedSearchRequest:
      type: object
      required: [brand]
      properties:
        brand:
          type: string
          minLength: 1
          description: 브랜드명
        productName:
          type: string
          default: ""
          description: 상품명 (선택)
        maxPerPlatform:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
          description: 플랫폼별 최대 결과 수

    UnifiedSearchResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            jobId:
              type: string
              format: uuid
              description: Job ID (UUIDv7)
            keyword:
              type: string
              description: 검색 키워드 (brand + productName)
            brand:
              type: string
              description: 브랜드명
            productName:
              type: string
              description: 상품명
            maxPerPlatform:
              type: integer
              description: 플랫폼별 최대 결과 수
            platforms:
              type: array
              description: 플랫폼별 검색 결과
              items:
                $ref: '#/components/schemas/PlatformSearchResult'
            summary:
              type: object
              properties:
                totalPlatforms:
                  type: integer
                  description: 전체 플랫폼 수
                successPlatforms:
                  type: integer
                  description: 성공한 플랫폼 수
                failedPlatforms:
                  type: integer
                  description: 실패한 플랫폼 수
                totalProducts:
                  type: integer
                  description: 전체 상품 수
                durationMs:
                  type: integer
                  description: 총 소요 시간 (ms)
            resultFilePath:
              type: string
              description: JSONL 결과 파일 경로

    PlatformSearchResult:
      type: object
      properties:
        platform:
          type: string
          description: 플랫폼명
        success:
          type: boolean
          description: 검색 성공 여부
        products:
          type: array
          items:
            $ref: '#/components/schemas/SimpleProduct'
        totalCount:
          type: integer
          description: 플랫폼 총 결과 수
        durationMs:
          type: integer
          description: 검색 소요 시간 (ms)
        error:
          type: string
          description: 에러 메시지 (실패 시)

    SimpleProduct:
      type: object
      properties:
        productName:
          type: string
          description: 상품명
        thumbnail:
          type: string
          description: 썸네일 URL
        productUrl:
          type: string
          description: 상품 URL (정규화됨)
        platform:
          type: string
          description: 플랫폼명

    # ==========================================================================
    # Filter Products API Schemas
    # ==========================================================================

    FilterProductsRequest:
      type: object
      required: [brand, product_name, product_names]
      properties:
        brand:
          type: string
          minLength: 1
          description: 브랜드명
        product_name:
          type: string
          minLength: 1
          description: 상품명 (타겟)
        product_names:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: |
            플랫폼별 상품명 목록

            ```json
            {
              "oliveyoung": ["상품1", "상품2"],
              "zigzag": ["상품A", "상품B"]
            }
            ```

    FilterProductsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            brand:
              type: string
              description: 브랜드명
            product_name:
              type: string
              description: 타겟 상품명
            platforms:
              type: array
              items:
                $ref: '#/components/schemas/PlatformValidationResult'
            usage:
              type: object
              properties:
                input_tokens:
                  type: integer
                  description: 입력 토큰 수
                output_tokens:
                  type: integer
                  description: 출력 토큰 수
                total_tokens:
                  type: integer
                  description: 총 토큰 수
                cost_usd:
                  type: number
                  format: float
                  description: 비용 (USD)
            durationMs:
              type: integer
              description: 처리 시간 (ms)
        error:
          type: object
          properties:
            code:
              type: string
              enum:
                - VALIDATION_ERROR
                - INVALID_ARGUMENT
                - PERMISSION_DENIED
                - RATE_LIMIT_EXCEEDED
                - INTERNAL_ERROR
                - SERVICE_UNAVAILABLE
                - UNKNOWN_ERROR
              description: 에러 코드
            message:
              type: string
              description: 에러 메시지

    PlatformValidationResult:
      type: object
      properties:
        platform:
          type: string
          description: 플랫폼명
        valid_indices:
          type: array
          items:
            type: integer
            minimum: 0
          description: 유효한 상품의 인덱스 배열

# ============================================================================
# Shell 스크립트 사용법
# ============================================================================
#
# ## 스케줄러 제어 (scheduler-control.sh)
#
# ```bash
# # 상태 확인
# ./scripts/scheduler-control.sh status
#
# # 스케줄러 시작
# ./scripts/scheduler-control.sh start
#
# # 스케줄러 중지
# ./scripts/scheduler-control.sh stop
#
# # 스케줄러 중지 + 대기 Job 삭제
# ./scripts/scheduler-control.sh stop --clear-queue
#
# # 원격 서버
# API_URL=http://remote-server:3989 ./scripts/scheduler-control.sh status
# ```
#
# ## 실행 중인 Job 확인 (check-running-jobs.sh)
#
# ```bash
# ./scripts/check-running-jobs.sh
#
# # 원격 서버
# API_URL=http://remote-server:3989 ./scripts/check-running-jobs.sh
# ```
#
# ## Worker 제어 (worker-control.sh)
#
# ```bash
# # Worker 상태 확인
# ./scripts/worker-control.sh status
#
# # 특정 Worker 재시작
# ./scripts/worker-control.sh restart oliveyoung
# ./scripts/worker-control.sh restart hwahae
#
# # 모든 Worker 재시작
# ./scripts/worker-control.sh restart all
#
# # 원격 서버
# API_URL=http://remote-server:3989 ./scripts/worker-control.sh status
# ```
#
# ## Alert Watcher 제어 (alert-watcher-control.sh)
#
# 테이블 모니터링 서비스 제어 스크립트 (collabo_banners, votes, pick_sections)
#
# ```bash
# # 상태 확인
# ./scripts/alert-watcher-control.sh status
#
# # Alert Watcher 시작
# ./scripts/alert-watcher-control.sh start
#
# # Alert Watcher 중지
# ./scripts/alert-watcher-control.sh stop
#
# # Alert Watcher 중지 + 대기 Job 삭제
# ./scripts/alert-watcher-control.sh stop --clear-queue
#
# # 원격 서버
# API_URL=http://remote-server:3989 ./scripts/alert-watcher-control.sh status
# ```
#
# ### 개별 모니터 테스트
# ```bash
# # Collabo Banner 모니터 테스트
# ./scripts/test-collabo-banner-monitor.sh
#
# # Votes 모니터 테스트
# ./scripts/test-votes-monitor.sh
#
# # Pick Sections 모니터 테스트
# ./scripts/test-pick-sections-monitor.sh
# ```
#
# ## 검색 API 스크립트
#
# ### 통합 검색 (6개 플랫폼 병렬)
# ```bash
# # 기본 사용법
# ./scripts/search-unified.sh "브랜드명" "상품명" [limit]
#
# # 예시
# ./scripts/search-unified.sh "라네즈" "워터뱅크 크림" 5
# ./scripts/search-unified.sh "토리든" "" 3
#
# # 원격 서버
# API_URL=http://remote-server:3989 ./scripts/search-unified.sh "토리든" "세럼" 5
# ```
#
# ### 단일 플랫폼 검색 (디버깅용)
# ```bash
# # 지그재그 검색 (curl 직접 호출)
# ./scripts/search-zigzag.sh "수분크림" 10
# ./scripts/search-zigzag.sh "토리든" 10 --json
#
# # 올리브영 검색 (Playwright)
# ./scripts/search-oliveyoung.sh "토리든" 10
#
# # 무신사 검색 (Playwright + Stealth)
# ./scripts/search-musinsa.sh "토리든" 10
#
# # 에이블리 검색 (Playwright + Stealth)
# ./scripts/search-ably.sh "토리든" 10
#
# # 컬리 검색 (Playwright + Stealth)
# ./scripts/search-kurly.sh "토리든" 10
#
# # 화해 검색 (Playwright + DOM 파싱)
# ./scripts/search-hwahae.sh "토리든" 10
# ```
#
# ## 워크플로우 테스트 스크립트
#
# ### Platform 워크플로우
# ```bash
# # 화해 업데이트 테스트
# LIMIT=5 SALE_STATUS=on_sale ./scripts/test-hwahae-update.sh
#
# # 무신사 검증 테스트 (업데이트 없음)
# LIMIT=10 ./scripts/test-musinsa-validation.sh
#
# # 올리브영 업데이트
# LIMIT=5 ./scripts/test-oliveyoung-update.sh
#
# # 지그재그 업데이트
# LIMIT=5 ./scripts/test-zigzag-update.sh
#
# # 컬리 업데이트
# LIMIT=5 ./scripts/test-kurly-update.sh
#
# # 에이블리 업데이트
# LIMIT=5 ./scripts/test-ably-update.sh
# ```
#
# ### Extract 워크플로우
# ```bash
# # ProductSet ID 기반 추출 + 업데이트
# ./scripts/test-extract-product-set-update.sh "product-set-uuid"
#
# # ProductSet ID 기반 검증
# ./scripts/test-extract-product-set-validation.sh "product-set-uuid"
#
# # URL 기반 추출
# ./scripts/test-extract-url-validation.sh "https://www.oliveyoung.co.kr/..."
# ```
#
# ### 환경변수
# | 변수 | 설명 | 기본값 |
# |------|------|--------|
# | API_URL | API 서버 주소 | http://localhost:3989 |
# | LIMIT | 조회할 상품 수. **생략 시 전체 조회** | 5 (테스트 스크립트) |
# | BATCH_SIZE | 배치 크기 | 10 |
# | CONCURRENCY | 동시 처리 수 | 1 (API), 4 (Playwright) |
# | WAIT_TIME_MS | Rate limiting 대기 시간 | 2500 |
# | SALE_STATUS | 대상 판매 상태 | on_sale |
# | UPDATE_SALE_STATUS | 판매 상태 업데이트 여부 | true |
#
# **주의**: 스케줄러는 limit 없이 실행되어 **전체 상품을 자동 pagination으로 조회**합니다.
# 테스트 시에만 LIMIT 환경변수를 사용하세요.
#
# ============================================================================
