#!/bin/bash
# LLM ê¸°ë°˜ ìƒí’ˆ í•„í„°ë§ API í…ŒìŠ¤íŠ¸
#
# POST /api/v2/search/filter-products ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
# - ë³¸í’ˆ í•„í„°ë§ (êµ¬ì„±í’ˆ/ì¦ì •í’ˆ/ë‹¤ë¥¸ ìƒí’ˆ ì œì™¸)
# - LLM ë¹„ìš© ë¡œê¹… í™•ì¸
#
# ì‚¬ìš©ë²•:
#   ./test-filter-products.sh           # ëª¨ë“  í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì‹¤í–‰
#   ./test-filter-products.sh --check   # í…ŒìŠ¤íŠ¸ + LLM ë¹„ìš© ë¡œê·¸ í™•ì¸

set -e

API_BASE_URL="${API_URL:-http://localhost:3989}/api/v2"
CHECK_COST="${1:-}"
TOTAL_TESTS=0
PASSED_TESTS=0

echo "ğŸ§ª LLM ìƒí’ˆ í•„í„°ë§ í…ŒìŠ¤íŠ¸"
echo "ğŸ“Š API: POST ${API_BASE_URL}/search/filter-products"
echo ""

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ í•¨ìˆ˜
run_test() {
  local TEST_NAME="$1"
  local JSON_PAYLOAD="$2"
  local EXPECTED_HINT="$3"  # ì˜ˆìƒ ê²°ê³¼ íŒíŠ¸ (ì„ íƒ)

  TOTAL_TESTS=$((TOTAL_TESTS + 1))
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ${TOTAL_TESTS}: ${TEST_NAME}"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  echo "ğŸ“¥ ìš”ì²­ ë°ì´í„°:"
  echo "${JSON_PAYLOAD}" | jq '.'
  echo ""

  echo "â³ API í˜¸ì¶œ ì¤‘..."
  START_TIME=$(python3 -c 'import time; print(int(time.time() * 1000))' 2>/dev/null || date +%s)

  RESPONSE=$(curl -s -X POST "${API_BASE_URL}/search/filter-products" \
    -H "Content-Type: application/json" \
    -d "${JSON_PAYLOAD}")

  END_TIME=$(python3 -c 'import time; print(int(time.time() * 1000))' 2>/dev/null || date +%s)
  DURATION=$((END_TIME - START_TIME))

  echo ""
  echo "ğŸ“¤ ì‘ë‹µ (${DURATION}ms):"
  echo "${RESPONSE}" | jq '.'
  echo ""

  # ì„±ê³µ ì—¬ë¶€ í™•ì¸
  SUCCESS=$(echo "${RESPONSE}" | jq -r '.success')
  if [ "$SUCCESS" == "true" ]; then
    PASSED_TESTS=$((PASSED_TESTS + 1))
    echo "âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ"

    # ê²°ê³¼ ìš”ì•½
    echo ""
    echo "ğŸ“Š ê²°ê³¼ ìš”ì•½:"
    echo "${RESPONSE}" | jq -r '.data.platforms[] | "   - \(.platform): valid_indices=\(.valid_indices)"'

    # í† í° ì‚¬ìš©ëŸ‰
    echo ""
    echo "ğŸ’° í† í° ì‚¬ìš©ëŸ‰:"
    echo "${RESPONSE}" | jq -r '.data.usage | "   - ì…ë ¥: \(.input_tokens) tokens"'
    echo "${RESPONSE}" | jq -r '.data.usage | "   - ì¶œë ¥: \(.output_tokens) tokens"'
    echo "${RESPONSE}" | jq -r '.data.usage | "   - ë¹„ìš©: $\(.cost_usd) (ì•½ â‚©\(.cost_usd * 1400 | floor))"'

    # ì˜ˆìƒ ê²°ê³¼ íŒíŠ¸ í‘œì‹œ
    if [ -n "$EXPECTED_HINT" ]; then
      echo ""
      echo "ğŸ’¡ ì˜ˆìƒ: ${EXPECTED_HINT}"
    fi
  else
    echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    echo "${RESPONSE}" | jq -r '.error'
  fi

  echo ""
}

# ============================================
# í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1: í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì„¸ëŸ¼
# ============================================
TEST1_PAYLOAD=$(cat <<'EOF'
{
  "brand": "í† ë¦¬ë“ ",
  "product_name": "ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼",
  "product_names": {
    "oliveyoung": [
      "[2025 ì–´ì›Œì¦ˆ] í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼ 100ml ì–´ì›Œì¦ˆ í•œì •ê¸°íš",
      "[1ë“±ì„¸ëŸ¼/ë‹¨ë…ê¸°íš] í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼ 50ml ê¸°íš(+ë©€í‹°íŒ¨ë“œ 10ë§¤)",
      "[NEW/ë‹¨ë…ê¸°íš] í† ë¦¬ë“  ë°¸ëŸ°ìŠ¤í’€ ì‹œì¹´ ì»¨íŠ¸ë¡¤ ì„¸ëŸ¼ 50ml ê¸°íš (+í¬ë¦¼ 20ml)"
    ],
    "zigzag": [
      "[ì§ì­í”½] í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼ 50ml+( ë‹¤ì´ë¸Œì¸ ì„¸ëŸ¼ 2ml*3ë§¤)",
      "[2ì¢…ì„¸íŠ¸] í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼ 50ml+40ml (+ë‹¤ì´ë¸Œì¸ ìˆ˜ë”©í¬ë¦¼ 2ml 5ë§¤+ë‹¤ì´ë¸Œì¸ ë§ˆìŠ¤í¬ 1ë§¤)",
      "[ì§ì­í”½] [SET] í† ë¦¬ë“  ë°¸ëŸ°ìŠ¤í’€ ì‹œì¹´ ì»¨íŠ¸ë¡¤ ì„¸ëŸ¼ 50ml + ë°¸ëŸ°ìŠ¤í’€ ì§„ì • í¬ë¦¼ 80ml (+ì‹œì¹´ ì§„ì • ì„¸ëŸ¼ 10ml+ì§„ì •í¬ë¦¼ 20ml)"
    ],
    "ably": [
      "í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ì„¸ëŸ¼ 50ml(+ë°¸ëŸ°ìŠ¤í’€ì‹œì¹´ì»¨íŠ¸ë¡¤ì„¸ëŸ¼10mlë¯¸ë‹ˆì–´ì³ì¦ì •)",
      "í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° ë©€í‹°íŒ¨ë“œ 80ë§¤(+ë°¸ëŸ°ìŠ¤í’€ì‹œì¹´ì»¨íŠ¸ë¡¤ì„¸ëŸ¼10mlë¯¸ë‹ˆì–´ì³ì¦ì •)",
      "í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì €ë¶„ì íˆì•Œë£¨ë¡ ì‚° í† ë„ˆ 300ml(+ë°¸ëŸ°ìŠ¤í’€ì‹œì¹´ì»¨íŠ¸ë¡¤ì„¸ëŸ¼10mlë¯¸ë‹ˆì–´ì³ì¦ì •)"
    ]
  }
}
EOF
)

run_test "í† ë¦¬ë“  ë‹¤ì´ë¸Œì¸ ì„¸ëŸ¼ (ê¸°ë³¸)" "$TEST1_PAYLOAD" "oliveyoung=[0,1], zigzag=[0,1], ably=[0]"

# ============================================
# í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 2: ë¡¬ì•¤ ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤ (ì¦ì •í’ˆ êµ¬ë¶„)
# ============================================
TEST2_PAYLOAD=$(cat <<'EOF'
{
  "brand": "ë¡¬ì•¤",
  "product_name": "ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤",
  "product_names": {
    "zigzag": [
      "[NEWì»¬ëŸ¬] ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤",
      "[NEWì»¬ëŸ¬] ë² ëŸ¬ ëŒ„ íŒ”ë ˆíŠ¸ (+ë¯¸ë‹ˆ ê¸€ë˜ìŠ¤íŒ… ì›Œí„° ê¸€ë¡œìŠ¤ #í˜ì–´ë¦¬ìƒ¤ë² íŠ¸ ì¦ì •)",
      "[NEWì»¬ëŸ¬] ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤X2"
    ],
    "oliveyoung": [
      "[2025 ì–´ì›Œì¦ˆ] ë¡¬ì•¤ ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤ ë‹¨í’ˆ/ê¸°íš"
    ],
    "musinsa": [
      "[NEW WARM] ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤",
      "ê¸€ë˜ìŠ¤íŒ… ì›Œí„° ê¸€ë¡œìŠ¤",
      "[NEW WARM][2PACK] ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤"
    ],
    "ably": [
      "[ë¡¬ì•¤Xì¡°ì•¤í”„ë Œì¦ˆ/í‹´ëšœë§ê¸°íš] ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤",
      "[ë³¸í’ˆì¦ì •] ë” ì¥¬ì‹œ ë˜ìŠ¤íŒ… í‹´íŠ¸ X2 (ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤ 08 ì²´ë¦¬ ì—… ì¦ì •)",
      "[ë³¸í’ˆì¦ì •] ê¸€ë˜ìŠ¤íŒ… ë©œíŒ… ë°¤ X2 (ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤ 07 ìŠ¤í”„ë§ í”¼ë²„ ì¦ì •)"
    ]
  }
}
EOF
)

run_test "ë¡¬ì•¤ ê¸€ë˜ìŠ¤íŒ… ì»¬ëŸ¬ ê¸€ë¡œìŠ¤ (ì¦ì •í’ˆ êµ¬ë¶„)" "$TEST2_PAYLOAD" "zigzag=[0,2], oliveyoung=[0], musinsa=[0,2], ably=[0] (í‹´íŠ¸/ë°¤ ë³¸í’ˆ, ê¸€ë¡œìŠ¤ëŠ” ì¦ì •í’ˆì´ë¯€ë¡œ ì œì™¸)"

# ============================================
# ê²°ê³¼ ìš”ì•½
# ============================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š ì „ì²´ ê²°ê³¼: ${PASSED_TESTS}/${TOTAL_TESTS} í…ŒìŠ¤íŠ¸ í†µê³¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# LLM ë¹„ìš© ë¡œê·¸ í™•ì¸ (--check ì˜µì…˜)
if [ "$CHECK_COST" == "--check" ]; then
  echo ""
  echo "ğŸ“ LLM ë¹„ìš© ë¡œê·¸ í™•ì¸..."

  TODAY=$(date +%Y-%m-%d)
  COST_FILE="results/${TODAY}/llm_cost__${TODAY}.jsonl"

  if [ -f "$COST_FILE" ]; then
    echo "   íŒŒì¼: ${COST_FILE}"
    echo ""
    echo "   ìµœê·¼ product_filtering ë ˆì½”ë“œ:"
    grep '"operation":"product_filtering"' "$COST_FILE" | tail -3 | jq '.'
  else
    echo "   âš ï¸  ë¹„ìš© ë¡œê·¸ íŒŒì¼ ì—†ìŒ: ${COST_FILE}"
    echo "   (Docker ì»¨í…Œì´ë„ˆ ë‚´ë¶€ results/ ë””ë ‰í† ë¦¬ í™•ì¸ í•„ìš”)"
  fi
fi

echo ""
echo "ğŸ‰ ì™„ë£Œ"
