# Multi-Worker Queue System
# Phase 2: 플랫폼별 독립 Worker 컨테이너
#
# Browser 기반: oliveyoung, ably, kurly (각 4GB, shm_size 필요)
# API 기반: hwahae, musinsa, zigzag (각 2GB)
# Default: 기타 (2GB)

x-worker-common: &worker-common
  build:
    context: ..
    dockerfile: docker/Dockerfile.dev
  env_file:
    - ../.env.local
  volumes:
    - ../:/app
    - /app/node_modules
    - ../logs:/app/logs
    - ../results:/app/results
  depends_on:
    - redis
  command: npm run worker
  restart: unless-stopped
  environment: &worker-env-common
    NODE_ENV: development
    REDIS_HOST: redis
    REDIS_PORT: "6379"
    WORKER_POLL_INTERVAL: "5000"
    TZ: Asia/Seoul
    LOG_LEVEL: info
    LOG_PRETTY: "true"
    LOG_DIR: /app/logs

x-browser-worker: &browser-worker
  <<: *worker-common
  shm_size: "2gb"
  deploy:
    resources:
      limits:
        memory: 4G

x-api-worker: &api-worker
  <<: *worker-common
  deploy:
    resources:
      limits:
        memory: 2G

services:
  # ============================================
  # API Server
  # ============================================
  product_scanner_dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: product_scanner_dev
    ports:
      - "3989:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - TZ=Asia/Seoul
      - SERVICE_NAME=server
      - LOG_LEVEL=info
      - LOG_PRETTY=true
      - LOG_DIR=/app/logs
    env_file:
      - ../.env.local
    volumes:
      - ../:/app
      - /app/node_modules
      - ../logs:/app/logs
      - ../results:/app/results
    depends_on:
      - redis
    command: npm run dev
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Browser-based Workers (Playwright)
  # ============================================
  worker_oliveyoung:
    <<: *browser-worker
    container_name: worker_oliveyoung
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-oliveyoung
      WORKER_PLATFORMS: oliveyoung

  worker_ably:
    <<: *browser-worker
    container_name: worker_ably
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-ably
      WORKER_PLATFORMS: ably

  worker_kurly:
    <<: *browser-worker
    container_name: worker_kurly
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-kurly
      WORKER_PLATFORMS: kurly

  # ============================================
  # API-based Workers (HTTP/GraphQL)
  # ============================================
  worker_hwahae:
    <<: *api-worker
    container_name: worker_hwahae
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-hwahae
      WORKER_PLATFORMS: hwahae

  worker_musinsa:
    <<: *api-worker
    container_name: worker_musinsa
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-musinsa
      WORKER_PLATFORMS: musinsa

  worker_zigzag:
    <<: *api-worker
    container_name: worker_zigzag
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-zigzag
      WORKER_PLATFORMS: zigzag

  # ============================================
  # Default Worker (기타)
  # ============================================
  worker_default:
    <<: *api-worker
    container_name: worker_default
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-default
      WORKER_PLATFORMS: default

  # ============================================
  # Alert Worker (Alert Watcher 전용)
  # ============================================
  worker_alert:
    <<: *api-worker
    container_name: worker_alert
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-alert
      WORKER_PLATFORMS: alert

  # ============================================
  # Scheduler (자동 Job 스케줄링)
  # ============================================
  scheduler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: scheduler
    env_file:
      - ../.env.local
    volumes:
      - ../:/app
      - /app/node_modules
      - ../logs:/app/logs
    depends_on:
      - redis
      - product_scanner_dev
    command: npm run scheduler
    restart: unless-stopped
    environment:
      NODE_ENV: development
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TZ: Asia/Seoul
      SERVICE_NAME: scheduler
      LOG_LEVEL: info
      LOG_PRETTY: "true"
      LOG_DIR: /app/logs
      # Scheduler 설정 (환경변수로 오버라이드 가능)
      SCHEDULER_PLATFORMS: hwahae,oliveyoung,zigzag,musinsa,ably,kurly
      SCHEDULER_CHECK_INTERVAL_MS: "10000"
      SCHEDULER_INTER_PLATFORM_DELAY_MS: "30000"
      SCHEDULER_SAME_PLATFORM_COOLDOWN_MS: "300000"
      SCHEDULER_ON_SALE_RATIO: "4"
      SCHEDULER_DEFAULT_LIMIT: "1000"
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================
  # Alert Watcher (테이블 모니터링 및 알림)
  # ============================================
  alert_watcher:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: alert_watcher
    env_file:
      - ../.env.local
    volumes:
      - ../:/app
      - /app/node_modules
      - ../logs:/app/logs
    depends_on:
      - redis
      - product_scanner_dev
    command: npm run alert-watcher
    restart: unless-stopped
    environment:
      NODE_ENV: development
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TZ: Asia/Seoul
      SERVICE_NAME: alert-watcher
      LOG_LEVEL: info
      LOG_PRETTY: "true"
      LOG_DIR: /app/logs
      # Alert Watcher 설정
      ALERT_WATCHER_RUN_ON_START: "false"
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================
  # Redis
  # ============================================
  redis:
    image: redis:8.2-alpine
    container_name: product_scanner_redis_dev
    command: redis-server --appendonly no --maxmemory 1gb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
