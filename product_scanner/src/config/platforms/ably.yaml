# a-bly 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑 (SSR + DOM fallback)

platform: ably
name: "에이블리"
baseUrl: "https://m.a-bly.com"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 2000
  SSR_EXTRACTION_WAIT_MS: 500

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 SSR 데이터 추출 (fallback: DOM)"
    playwright:
      headless: true
      timeout: 60000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://m.a-bly.com/goods/${goodsId}"
          waitUntil: "domcontentloaded"
          timeout: 45000
          description: "상품 상세 페이지 접속 + API 캡처"

        # Step 2: API 응답 대기
        - action: "wait"
          timeout: 2000
          description: "API 응답 대기"

      # 데이터 추출 전략
      extraction:
        method: "evaluate"
        api_pattern: "/api/v3/goods/${goodsId}/basic/"
        description: "Network API 응답 캡처 (fallback: Meta 태그)"
        script: |
          () => {
            try {
              // 1. __NEXT_DATA__ 에서 SSR 데이터 추출 시도
              const script = document.getElementById('__NEXT_DATA__');
              if (script && script.textContent) {
                const data = JSON.parse(script.textContent);
                const queries = data.props?.pageProps?.dehydratedState?.queries || [];

                // API 응답 데이터 찾기 (/api/v3/goods/{id}/basic/)
                for (const query of queries) {
                  const goods = query.state?.data?.goods;
                  if (goods && goods.name) {
                    return {
                      name: goods.name,
                      brand: goods.market?.name || '',
                      title_images: goods.cover_images || [],
                      consumer_price: goods.price_info?.consumer || 0,
                      price: goods.price_info?.thumbnail_price || goods.price_info?.consumer || 0,
                      sale_status: goods.sale_type === 'ON_SALE' ? 'on_sale' : (goods.sale_type === 'SOLD_OUT' ? 'sold_out' : 'off_sale'),
                      _source: 'ssr_api'
                    };
                  }
                }
              }

              // 2. Fallback: Meta 태그 기반 추출
              const metaTitle = document.querySelector('meta[property="og:title"]')?.getAttribute('content') || '';
              const metaImage = document.querySelector('meta[property="og:image"]')?.getAttribute('content') || '';

              if (metaTitle) {
                // 제목에서 가격 분리 (e.g., "상품명 - 에이블리 스토어")
                const cleanTitle = metaTitle.replace(/\s*-\s*에이블리.*$/, '').trim();

                // 버튼으로 판매 상태 확인
                const bodyText = document.body.textContent || '';
                const hasBuyButton = bodyText.includes('구매하기');
                const isSoldOut = bodyText.includes('품절') || bodyText.includes('재입고');
                const isOffSale = bodyText.includes('판매 중인 상품이 아닙니다') || window.location.href.includes('/today');

                return {
                  name: cleanTitle,
                  brand: '',
                  title_images: metaImage ? [metaImage] : [],
                  consumer_price: 0,
                  price: 0,
                  sale_status: isOffSale ? 'off_sale' : (isSoldOut ? 'sold_out' : 'on_sale'),
                  _source: 'meta',
                  _note: 'SSR data not found, using meta tags'
                };
              }

              // 3. 최종 Fallback: not_found
              return {
                name: 'not_found',
                brand: '',
                title_images: [],
                consumer_price: 0,
                price: 0,
                sale_status: 'off_sale',
                _source: 'not_found'
              };

            } catch (error) {
              return {
                name: '추출 실패',
                brand: '',
                title_images: [],
                consumer_price: 0,
                price: 0,
                sale_status: 'off_sale',
                _source: 'error',
                _error: error.message
              };
            }
          }

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "productName"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "thumbnail"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "originalPrice"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "discountedPrice"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "saleStatus"
    type: "string"
    required: true

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "a-bly 플랫폼 rate limiting"

  # Concurrency Settings
  concurrency:
    max: 10
    default: 4
    description: "배치 병렬 처리 설정"
