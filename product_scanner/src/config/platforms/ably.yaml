# a-bly 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑 (SSR + DOM fallback)

platform: ably
name: "에이블리"
baseUrl: "https://m.a-bly.com"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 2000
  SSR_EXTRACTION_WAIT_MS: 500

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 SSR 데이터 추출 (fallback: DOM)"
    playwright:
      headless: true
      timeout: 60000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://m.a-bly.com/goods/${goodsId}"
          waitUntil: "networkidle"
          timeout: 45000
          description: "상품 상세 페이지 접속"

        # Step 2: SSR 데이터 렌더링 대기
        - action: "wait"
          timeout: 1000
          description: "페이지 렌더링 대기"

      # 데이터 추출 전략
      extraction:
        method: "evaluate"
        description: "NextJS SSR 데이터 우선 추출, 품절 시 DOM fallback"
        script: |
          () => {
            // ===== Helper Functions =====

            /**
             * 가격 파싱
             * @param {number} price - 숫자형 가격
             * @returns {number}
             */
            const parsePrice = (price) => {
              return typeof price === 'number' ? price : 0;
            };

            /**
             * Sale Type 매핑 (a-bly → standard)
             * @param {string} saleType - a-bly sale_type
             * @returns {string} - on_sale|sold_out|off_sale
             */
            const mapSaleType = (saleType) => {
              const mapping = {
                'ON_SALE': 'on_sale',
                'SOLD_OUT': 'sold_out',
                'DISCONTINUED': 'off_sale'
              };
              return mapping[saleType] || 'off_sale';
            };

            // ===== Error Handling Wrapper =====

            try {
              // ===== Step 1: SSR 데이터 추출 시도 (__NEXT_DATA__) =====

              const ssrScript = document.getElementById('__NEXT_DATA__');
              if (ssrScript) {
                const fullData = JSON.parse(ssrScript.textContent);
                const queries = fullData.props?.pageProps?.serverQueryClient?.queries || [];

                // SSR 데이터 있음 (판매중 상품)
                if (queries.length > 0 && queries[0]?.state?.data?.goods) {
                  const goods = queries[0].state.data.goods;

                  return {
                    productName: goods.name || '',
                    originalPrice: parsePrice(goods.price_info?.consumer),
                    discountedPrice: parsePrice(goods.price_info?.thumbnail_price),
                    saleStatus: mapSaleType(goods.sale_type),
                    thumbnail: goods.cover_images?.[0] || '',
                    additionalImages: goods.cover_images?.slice(1) || [],
                    dataSource: 'ssr',
                    rawSaleType: goods.sale_type
                  };
                }
              }

              // ===== Step 2: DOM Fallback (품절 상품) =====

              // Alert 감지 (판매중지)
              const hasAlert = document.body.textContent.includes('판매 중인 상품이 아닙니다');
              if (hasAlert) {
                return {
                  productName: '판매중지 상품',
                  originalPrice: 0,
                  discountedPrice: 0,
                  saleStatus: 'off_sale',
                  thumbnail: '',
                  additionalImages: [],
                  dataSource: 'alert',
                  rawSaleType: 'DISCONTINUED'
                };
              }

              // DOM에서 추출 (품절 상품)
              const productNameEl = document.querySelector('h1.css-1o0y9eh');
              const productName = productNameEl?.textContent?.trim() || '';

              // 가격 정보
              const priceContainer = document.querySelector('.css-1v1r1h4');
              const originalPriceEl = priceContainer?.querySelector('.css-lp1cuj');
              const discountedPriceEl = priceContainer?.querySelector('.css-1o7hd8w');

              const originalPrice = originalPriceEl ?
                parseInt(originalPriceEl.textContent.replace(/[^0-9]/g, '')) : 0;
              const discountedPrice = discountedPriceEl ?
                parseInt(discountedPriceEl.textContent.replace(/[^0-9]/g, '')) : 0;

              // 품절 버튼 확인
              const soldOutBtn = document.querySelector('button.css-5tujns');
              const isSoldOut = soldOutBtn?.textContent?.includes('품절') || false;

              // 썸네일 추출
              const thumbnailEl = document.querySelector('img.css-wdz79h');
              const thumbnail = thumbnailEl?.src || '';

              return {
                productName: productName,
                originalPrice: originalPrice,
                discountedPrice: discountedPrice,
                saleStatus: isSoldOut ? 'sold_out' : 'on_sale',
                thumbnail: thumbnail,
                additionalImages: [],
                dataSource: 'dom',
                rawSaleType: isSoldOut ? 'SOLD_OUT' : 'ON_SALE'
              };

            } catch (error) {
              // 에러 발생 시 기본값 반환
              return {
                productName: '추출 실패',
                originalPrice: 0,
                discountedPrice: 0,
                saleStatus: 'off_sale',
                thumbnail: '',
                additionalImages: [],
                dataSource: 'error',
                error: error.message
              };
            }
          }

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "productName"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "thumbnail"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "originalPrice"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "discountedPrice"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "saleStatus"
    type: "string"
    required: true

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "a-bly 플랫폼 rate limiting"

  # Concurrency Settings
  concurrency:
    max: 10
    default: 4
    description: "배치 병렬 처리 설정"
