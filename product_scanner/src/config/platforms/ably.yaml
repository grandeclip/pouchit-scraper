# a-bly 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑 (SSR + DOM fallback)

platform: ably
name: "에이블리"
baseUrl: "https://m.a-bly.com"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 2000
  SSR_EXTRACTION_WAIT_MS: 500

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 SSR 데이터 추출 (fallback: DOM)"
    playwright:
      headless: true
      timeout: 60000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://m.a-bly.com/goods/${goodsId}"
          waitUntil: "domcontentloaded"
          timeout: 45000
          description: "상품 상세 페이지 접속 + API 캡처"

        # Step 2: API 응답 대기
        - action: "wait"
          timeout: 2000
          description: "API 응답 대기"

      # 데이터 추출 전략 - Extractor Pattern 사용
      # 참고: src/extractors/ably/AblyExtractor.ts
      extraction:
        # API 캡처 우선 (AblyApiCaptureStrategy)
        api_pattern: "/api/v3/goods/${goodsId}/basic/"
        # Fallback: AblyExtractor 클래스 사용 (SSR → Meta)
        extractor: "ably"
        description: "API 캡처 우선 → Extractor fallback (SSR → Meta)"

# Selector 정의 (Fallback용)
selectors:
  # Meta 태그 (SSR 없을 때 fallback)
  meta:
    title: 'meta[property="og:title"]'
    image: 'meta[property="og:image"]'

# 판매 상태 패턴 (Sale Status Detection)
# 참고: AblySaleStatusExtractor.ts
sale_status_patterns:
  sold_out:
    - "품절"
    - "재입고"
  off_sale:
    text:
      - "판매 중인 상품이 아닙니다"
    url:
      - "/today"

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "productName"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "thumbnail"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "originalPrice"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "discountedPrice"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "saleStatus"
    type: "string"
    required: true

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "a-bly 플랫폼 rate limiting"

  # Concurrency Settings
  concurrency:
    max: 10
    default: 4
    description: "배치 병렬 처리 설정"
