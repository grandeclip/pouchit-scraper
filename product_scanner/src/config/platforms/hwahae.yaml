# í™”í•´(Hwahae) í”Œë«í¼ ì„¤ì •
# ë‹¤ì¤‘ ì „ëµ ì§€ì›: API + Playwright

platform: hwahae
name: "í™”í•´"
baseUrl: "https://gateway.hwahae.co.kr"
apiVersion: "v14"

# API ì—”ë“œí¬ì¸íŠ¸
endpoints:
  goodsDetail: "${baseUrl}/${apiVersion}/commerce/goods/${goodsId}"

# ìŠ¤ìº” ì „ëµ (Strategy Pattern)
# priority ë‚®ì„ìˆ˜ë¡ ìš°ì„ ìˆœìœ„ ë†’ìŒ (1 > 2)
strategies:
  # ì „ëµ 1: HTTP API (ë¹ ë¥´ê³  íš¨ìœ¨ì )
  - id: "api"
    type: "http"
    priority: 1
    description: "API ê¸°ë°˜ ë°ì´í„° í˜ì¹­ (ê¶Œì¥)"
    http:
      method: GET
      headers:
        # ë¸Œë¼ìš°ì € ì‹ë³„ í—¤ë” (Chrome 131)
        User-Agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"
        sec-ch-ua: '"Chromium";v="131", "Google Chrome";v="131", "Not_A Brand";v="99"'
        sec-ch-ua-mobile: "?0"
        sec-ch-ua-platform: '"macOS"'
        # ìš”ì²­ íƒ€ì… í—¤ë”
        Accept: "*/*"
        Accept-Language: "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7"
        Accept-Encoding: "gzip, deflate, br, zstd"
        # CORS ë³´ì•ˆ í—¤ë”
        Sec-Fetch-Site: "same-site"
        Sec-Fetch-Mode: "cors"
        Sec-Fetch-Dest: "empty"
        # Referer: ë©”ì¸ í˜ì´ì§€ (ì‹¤ì œ ë¸Œë¼ìš°ì € ë™ì‘ê³¼ ì¼ì¹˜)
        Referer: "https://www.hwahae.co.kr/"
      timeout: 10000
      retryCount: 3
      retryDelay: 1000
      # Rate limiting ë°©ì§€ ì„¤ì •
      requestDelay: 1000  # ê° ìš”ì²­ ì‚¬ì´ 1ì´ˆ ëŒ€ê¸° (Gentle wait, AWS WAF ìš°íšŒ)

  # TODO: Playwright ì „ëµ ì¬í™œì„±í™” í•„ìš”
  # ğŸ“„ ìƒì„¸ ë¬¸ì„œ: docs/hwahae-playwright-issue.md
  # ğŸ”’ ë¹„í™œì„±í™” ì‚¬ìœ : AWS WAFê°€ Docker í—¤ë“œë¦¬ìŠ¤ ë¸Œë¼ìš°ì €ë¥¼ ì°¨ë‹¨
  # ğŸ”§ í•´ê²° ë°©ì•ˆ: Residential Proxy ë„ì… ë˜ëŠ” Browser as a Service ì‚¬ìš©
  # âœ… í˜„ì¬ ìƒíƒœ: API ì „ëµìœ¼ë¡œ ëª¨ë“  ìš”êµ¬ì‚¬í•­ ì¶©ì¡± (Production Ready)
  #
  # ì „ëµ 2: Playwright ë¸Œë¼ìš°ì € (INACTIVE - AWS WAF ì°¨ë‹¨)
  # - id: "browser"
  #   type: "playwright"
  #   priority: 2
  #   description: "ë¸Œë¼ìš°ì € ê¸°ë°˜ ìŠ¤í¬ë˜í•‘ - ë©”ì¸ í˜ì´ì§€ ê±°ì³ì„œ ì´ë™ (Realistic Navigation)"
  #   playwright:
  #     headless: true
  #     timeout: 30000
  #
  #     # ì‚¬ëŒì²˜ëŸ¼ ì›€ì§ì´ëŠ” ë„¤ë¹„ê²Œì´ì…˜ ì „ëµ
  #     navigationSteps:
  #       # Step 1: ë©”ì¸ í˜ì´ì§€ ë¨¼ì € ë°©ë¬¸ (í—¤ë” ì •ë³´ ìˆ˜ì§‘)
  #       - action: "navigate"
  #         url: "https://www.hwahae.co.kr"
  #         description: "ë©”ì¸ í˜ì´ì§€ ì ‘ì† (í—¤ë” ì¿ í‚¤ íšë“)"
  #
  #       - action: "wait"
  #         timeout: 2000
  #         description: "í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°"
  #
  #       # Step 2: ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™
  #       - action: "navigate"
  #         url: "https://www.hwahae.co.kr/goods/${goodsId}"
  #         description: "ìƒí’ˆ í˜ì´ì§€ë¡œ ì´ë™"
  #
  #       - action: "wait"
  #         timeout: 5000
  #         description: "í˜ì´ì§€ ë¡œë”© ë° ë Œë”ë§ ëŒ€ê¸° (React ì•± ì´ˆê¸°í™”)"
  #
  #     # ë°ì´í„° ì¶”ì¶œ ì „ëµ
  #     extraction:
  #       method: "evaluate"
  #       description: "DOMì—ì„œ ë°ì´í„° ì¶”ì¶œ (ë²„íŠ¼ ê¸°ë°˜ sale_status)"
  #       script: |
  #         () => {
  #           // ìƒí’ˆëª… ì¶”ì¶œ (document.titleì—ì„œ)
  #           const titleText = document.title || '';
  #           const productNameMatch = titleText.match(/^(.+?)\s+ìƒí’ˆì˜\s+ì •ë³´/);
  #           const productName = productNameMatch ? productNameMatch[1].trim() : '';
  #
  #           // ë¸Œëœë“œ ì¶”ì¶œ (a[href*="/search?q="] ë§í¬)
  #           const brandElement = document.querySelector('a[href*="/search?q="]');
  #           const brand = brandElement?.textContent?.trim() || '';
  #
  #           // ì´ë¯¸ì§€ ì¶”ì¶œ
  #           const imageElement = document.querySelector('img[alt="ìƒí’ˆ ì´ë¯¸ì§€"]');
  #           const thumbnail = imageElement?.src || '';
  #
  #           // ì •ê°€ ì¶”ì¶œ ("ì •ê°€" í…ìŠ¤íŠ¸ ë‹¤ìŒ ìš”ì†Œì—ì„œ)
  #           let consumerPrice = 0;
  #           const priceLabels = Array.from(document.querySelectorAll('*')).filter(el =>
  #             el.textContent?.trim() === 'ì •ê°€' && el.children.length === 0
  #           );
  #           if (priceLabels.length > 0) {
  #             const priceContainer = priceLabels[0].parentElement;
  #             const priceText = priceContainer?.textContent?.match(/(\d{1,3}(?:,\d{3})*)\s*ì›/);
  #             if (priceText) {
  #               consumerPrice = parseInt(priceText[1].replace(/,/g, ''));
  #             }
  #           }
  #
  #           // íŒë§¤ê°€ ì¶”ì¶œ (em í• ì¸ìœ¨ ê·¼ì²˜)
  #           let price = 0;
  #           const discountElement = document.querySelector('em');
  #           if (discountElement) {
  #             const priceContainer = discountElement.parentElement?.parentElement;
  #             const priceText = priceContainer?.textContent?.match(/(\d{1,3}(?:,\d{3})*)\s*ì›/);
  #             if (priceText) {
  #               price = parseInt(priceText[1].replace(/,/g, ''));
  #             }
  #           }
  #
  #           // Sale Status íŒë‹¨ ë¡œì§ (ë²„íŠ¼ ê¸°ë°˜)
  #           const detectSaleStatus = () => {
  #             // 1. í˜ì´ì§€ ì°¾ì„ ìˆ˜ ì—†ìŒ ì²´í¬ (404)
  #             const errorHeading = document.querySelector('h1')?.textContent?.trim();
  #             if (errorHeading && errorHeading.includes('í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†')) {
  #               return 'STSEL'; // íŒë§¤ì¤‘ì§€/ì‚­ì œ
  #             }
  #
  #             // 2. í’ˆì ˆ ë²„íŠ¼ ì²´í¬
  #             const soldOutButton = Array.from(document.querySelectorAll('button')).find(btn =>
  #               btn.textContent?.trim().includes('í’ˆì ˆ')
  #             );
  #             if (soldOutButton) {
  #               return 'SLDOT'; // í’ˆì ˆ
  #             }
  #
  #             // 3. ë°”ë¡œ êµ¬ë§¤ ë²„íŠ¼ ì²´í¬
  #             const buyButton = Array.from(document.querySelectorAll('button')).find(btn =>
  #               btn.textContent?.trim() === 'ë°”ë¡œ êµ¬ë§¤'
  #             );
  #             if (buyButton && !buyButton.disabled) {
  #               return 'SELNG'; // íŒë§¤ì¤‘
  #             }
  #
  #             // 4. ê¸°íƒ€ (ê¸°ë³¸ê°’)
  #             return 'STSEL'; // íŒë§¤ì¤‘ì§€
  #           };
  #
  #           return {
  #             name: productName,
  #             title_images: thumbnail ? [thumbnail] : [],
  #             consumer_price: consumerPrice,
  #             price: price,
  #             sale_status: detectSaleStatus(),
  #             _source: 'dom'
  #           };
  #         }

# í•„ë“œ ë§¤í•‘ ê·œì¹™
fieldMapping:
  # ìƒí’ˆëª…
  productName:
    source: "name"
    type: "string"
    required: true

  # ì¸ë„¤ì¼ (ì²« ë²ˆì§¸ íƒ€ì´í‹€ ì´ë¯¸ì§€)
  thumbnail:
    source: "title_images[0]"
    type: "string"
    required: true
    # URL ì •ê·œí™”: ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°
    normalize: true

  # ì •ê°€ (consumer_price)
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # íŒë§¤ê°€ (price)
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # íŒë§¤ ìƒíƒœ
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    # API â†’ CSV ë§¤í•‘
    mapping:
      SELNG: "on_sale"      # íŒë§¤ì¤‘
      SLDOT: "sold_out"     # ì†”ë“œì•„ì›ƒ
      STSEL: "off_sale"     # íŒë§¤ì¤‘ì§€

# ê²€ì¦ ê·œì¹™
validation:
  # ê°€ê²© ë³€ë™ ì„ê³„ê°’ (10% ì´ìƒ ì°¨ì´ë‚˜ë©´ warning)
  priceThreshold: 0.10

  # URL ì •ê·œí™” (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°)
  normalizeUrls: true

  # ì—„ê²©í•œ ë§¤ì¹­ ëª¨ë“œ
  strictMode: false

# ì—ëŸ¬ ì²˜ë¦¬
errorHandling:
  # 404 Not Found â†’ ìƒí’ˆ ì‚­ì œë¨
  notFound: "product_deleted"

  # 429 Too Many Requests â†’ Rate Limiting
  rateLimitDelay: 2000

  # 500 Internal Server Error â†’ ì¬ì‹œë„
  serverErrorRetry: true
