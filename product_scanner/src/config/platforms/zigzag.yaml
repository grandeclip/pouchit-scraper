# ZigZag(ì§€ê·¸ì¬ê·¸) í”Œë«í¼ ì„¤ì •
# ì „ëµ: Playwright ë¸Œë¼ìš°ì € ê¸°ë°˜ ìŠ¤í¬ë˜í•‘ (__NEXT_DATA__ ì¶”ì¶œ)

platform: zigzag
name: "ì§€ê·¸ì¬ê·¸"
baseUrl: "https://zigzag.kr"

# URL í…œí”Œë¦¿ (Phase 2: Extract Service)
urlTemplates:
  productDetail: "https://zigzag.kr/catalog/products/${productId}"

# ìƒí’ˆ ID ì¶”ì¶œ íŒ¨í„´
productIdPattern:
  regex: "/catalog/products/(\\d+)"
  group: 1

# Extractor ì„¤ì • (Phase 1 ë¦¬íŒ©í„°ë§)
extractor: "zigzag"

# ì—”ë“œí¬ì¸íŠ¸ (Playwright ì „ìš©ì´ë¯€ë¡œ ë¹ˆ ê°ì²´)
endpoints: {}

# ìŠ¤ìº” ì „ëµ (Strategy Pattern)
strategies:
  # ì „ëµ 1: GraphQL API (ë¹ ë¥´ê³  íš¨ìœ¨ì )
  - id: "graphql"
    type: "graphql"
    priority: 1
    description: "GraphQL API ê¸°ë°˜ ë°ì´í„° í˜ì¹­ (ê¶Œì¥)"
    graphql:
      endpoint: "https://api.zigzag.kr/api/2/graphql/GetCatalogProductDetailPageOption"
      method: POST
      headers:
        Content-Type: "application/json"
        Accept: "*/*"
        Origin: "https://zigzag.kr"
        Referer: "https://zigzag.kr/"
        User-Agent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
      query: |
        query GetCatalogProductDetailPageOption($catalog_product_id: ID!, $input: PdpBaseInfoInput) {
          pdp_option_info(catalog_product_id: $catalog_product_id, input: $input) {
            catalog_product {
              id
              name
              shop_name
              sales_status
              display_status
              is_purchasable
              product_price {
                max_price_info { price }
                final_discount_info { discount_price }
                display_final_price {
                  final_price {
                    price
                    badge { text }
                  }
                  final_price_additional {
                    price
                    badge { text }
                  }
                }
              }
              matched_item_list {
                sales_status
                display_status
              }
              product_image_list {
                image_type
                pdp_thumbnail_url
              }
            }
          }
        }
      variables:
        catalog_product_id: "${productId}"
        input:
          catalog_product_id: "${productId}"
          entry_source_type: ""
      timeout: 10000
      retryCount: 3
      retryDelay: 1000
      requestDelay: 1000  # ê° ìš”ì²­ ì‚¬ì´ 1ì´ˆ ëŒ€ê¸°

  # TODO: Playwright ì „ëµ ì¬í™œì„±í™” í•„ìš”
  # ğŸ“„ ë¹„í™œì„±í™” ì‚¬ìœ : GraphQL APIë¡œ ëŒ€ë¶€ë¶„ì˜ ìƒí’ˆ ì •ë³´ ì¡°íšŒ ê°€ëŠ¥ (íŒë§¤ì¤‘ë‹¨ ì œì™¸)
  # ğŸ”§ í™œìš© ì‹œì : GraphQLì—ì„œ null ë°˜í™˜ ì‹œ fallback ì „ëµìœ¼ë¡œ ì‚¬ìš©
  # âœ… í˜„ì¬ ìƒíƒœ: GraphQL ì „ëµìœ¼ë¡œ ëª¨ë“  ìš”êµ¬ì‚¬í•­ ì¶©ì¡±
  #
  # ì „ëµ 2: Playwright ë¸Œë¼ìš°ì € (INACTIVE - Fallback ì „ìš©)
  # - id: "browser"
  #   type: "playwright"
  #   priority: 2
  #   description: "ë¸Œë¼ìš°ì € ê¸°ë°˜ __NEXT_DATA__ ì¶”ì¶œ"
  #   playwright:
  #     headless: true
  #     timeout: 30000
  #
  #     # ë¸Œë¼ìš°ì € ì„¤ì •
  #     browserOptions:
  #       args:
  #         - "--disable-blink-features=AutomationControlled"
  #         - "--no-sandbox"
  #         - "--disable-setuid-sandbox"
  #
  #     # Context ì„¤ì • (ëª¨ë°”ì¼)
  #     contextOptions:
  #       viewport:
  #         width: 375
  #         height: 812
  #       userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
  #       isMobile: true
  #       hasTouch: true
  #       deviceScaleFactor: 3
  #       extraHTTPHeaders:
  #         Accept: "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8"
  #         Accept-Language: "ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7"
  #         Accept-Encoding: "gzip, deflate, br"
  #         Origin: "https://zigzag.kr"
  #         Referer: "https://zigzag.kr/"
  #
  #     # ë„¤ë¹„ê²Œì´ì…˜ ì „ëµ
  #     navigationSteps:
  #       # Step 1: í™ˆ í˜ì´ì§€ ì ‘ì† (ì¿ í‚¤ íšë“)
  #       - action: "navigate"
  #         url: "https://zigzag.kr"
  #         description: "í™ˆ í˜ì´ì§€ ì ‘ì† (ì„¸ì…˜ ì´ˆê¸°í™”)"
  #
  #       # Step 2: ì´ˆê¸° ëŒ€ê¸°
  #       - action: "wait"
  #         timeout: 1000
  #         description: "í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°"
  #
  #       # Step 3: ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
  #       - action: "navigate"
  #         url: "https://zigzag.kr/catalog/products/${productId}"
  #         description: "ìƒí’ˆ ìƒì„¸ í˜ì´ì§€ ì ‘ì†"
  #
  #       # Step 4: í˜ì´ì§€ ë Œë”ë§ ëŒ€ê¸°
  #       - action: "wait"
  #         timeout: 2000
  #         description: "í˜ì´ì§€ ë Œë”ë§ ëŒ€ê¸°"
  #
  #     # ë°ì´í„° ì¶”ì¶œ ì „ëµ (__NEXT_DATA__ ê¸°ë°˜)
  #     extraction:
  #       method: "next_data_schema"
  #       description: "Next.js __NEXT_DATA__ SSR ë°ì´í„° ì¶”ì¶œ"
  #       extractor: "NextDataSchemaExtractor"
  #       config:
  #         selector: 'script#__NEXT_DATA__'
  #         dataPath: "props.pageProps"
  #         fallback:
  #           name: "íŒë§¤ì¤‘ë‹¨ ìƒí’ˆ"
  #           thumbnail: "https://via.placeholder.com/1x1"
  #           price: 0
  #           sale_status: "SUSPENDED"

# í•„ë“œ ë§¤í•‘ ê·œì¹™
fieldMapping:
  # ìƒí’ˆëª…
  productName:
    source: "product.name"
    type: "string"
    required: true

  # ë¸Œëœë“œ
  brand:
    source: "shop.name"
    type: "string"
    required: true

  # ì¸ë„¤ì¼
  thumbnail:
    source: "product.product_image_list[?image_type==MAIN].pdp_thumbnail_url"
    type: "string"
    required: true
    normalize: true

  # ì •ê°€
  originalPrice:
    source: "product.product_price.max_price_info.price"
    type: "number"
    required: true

  # íŒë§¤ê°€
  discountedPrice:
    source: "product.product_price.final_discount_info.discount_price"
    type: "number"
    required: true

  # íŒë§¤ ìƒíƒœ
  saleStatus:
    source: "product.sales_status"
    type: "enum"
    required: true
    mapping:
      ON_SALE: "on_sale"       # íŒë§¤ì¤‘
      SOLD_OUT: "sold_out"     # í’ˆì ˆ
      SUSPENDED: "off_sale"    # íŒë§¤ì¤‘ë‹¨

  # êµ¬ë§¤ ê°€ëŠ¥ ì—¬ë¶€
  isPurchasable:
    source: "product.is_purchasable"
    type: "boolean"
    required: true

  # ë…¸ì¶œ ìƒíƒœ
  displayStatus:
    source: "product.display_status"
    type: "enum"
    required: true

# ê²€ì¦ ê·œì¹™
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# ì—ëŸ¬ ì²˜ë¦¬
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Validation Node ì„¤ì • (Workflow ì „ìš©)
validationConfig:
  homeUrl: "https://zigzag.kr"
  productUrlTemplate: "https://zigzag.kr/catalog/products/${productId}"
  nextDataConfig:
    selector: "#__NEXT_DATA__"
    dataPath: "props.pageProps"
    fallback:
      name: "ì‚­ì œëœ ìƒí’ˆ"
      thumbnail: ""
      price: 0
      sale_status: "off_sale"

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2500  # ê° ìƒí’ˆ ìŠ¤ìº” ê°„ ëŒ€ê¸° ì‹œê°„ (Hwahae ì°¸ê³ )
    description: "ZigZag GraphQL API rate limiting"

  # Concurrency Settings (ë³‘ë ¬ ì²˜ë¦¬ ì„¤ì •)
  concurrency:
    max: 1        # ìµœëŒ€ ë³‘ë ¬ ê°œìˆ˜ (Hwahae ì°¸ê³ : ìˆœì°¨ ì²˜ë¦¬)
    default: 1    # ê¸°ë³¸ ë³‘ë ¬ ê°œìˆ˜
    description: "ìˆœì°¨ ì²˜ë¦¬ (CloudFront 403 ë°©ì§€)"
