# 올리브영(Oliveyoung) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: oliveyoung
name: "올리브영"
baseUrl: "https://www.oliveyoung.co.kr"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정
      contextOptions:
        viewport:
          width: 1920
          height: 1080
        userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://www.oliveyoung.co.kr/store/goods/getGoodsDetail.do?goodsNo=${goodsId}"
          description: "상품 상세 페이지 접속"

        # Step 2: 페이지 로딩 대기
        - action: "wait"
          timeout: 3000
          description: "페이지 렌더링 대기"

      # 데이터 추출 전략
      extraction:
        method: "evaluate"
        description: "DOM에서 상품 정보 추출"
        script: |
          () => {
            // 상품명 추출
            const productNameEl = document.querySelector('.prd_name');
            const productName = productNameEl?.textContent?.trim() || '';

            // 1. 상품 정보 없음 체크 (삭제/리다이렉트된 상품)
            if (!productName) {
              return {
                name: '삭제된 상품',
                brand: '',
                title_images: ['https://via.placeholder.com/1x1'],
                consumer_price: 0,
                price: 0,
                sale_status: 'STSEL',
                _source: 'not_found',
                _redirected: true
              };
            }

            // 브랜드 추출
            const brandEl = document.querySelector('.prd_brand');
            const brand = brandEl?.textContent?.trim() || '';

            // 이미지 추출
            const imageEl = document.querySelector('.prd_img img');
            const thumbnail = imageEl?.src || '';

            // 정가 추출 (price-1)
            const originalPriceEl = document.querySelector('.price-1');
            const originalPriceText = originalPriceEl?.textContent?.trim() || '';
            const originalPriceMatch = originalPriceText.match(/(\d{1,3}(?:,\d{3})*)/);
            const consumerPrice = originalPriceMatch ? parseInt(originalPriceMatch[1].replace(/,/g, '')) : 0;

            // 판매가 추출 (price-2)
            const priceEl = document.querySelector('.price-2');
            const priceText = priceEl?.textContent?.trim() || '';
            const priceMatch = priceText.match(/(\d{1,3}(?:,\d{3})*)/);
            const price = priceMatch ? parseInt(priceMatch[1].replace(/,/g, '')) : 0;

            // 판매 상태 판단 로직 (가시성 기반 체크)
            const detectSaleStatus = () => {
              // 1. 페이지 에러 체크
              const errorEl = document.querySelector('h1');
              if (errorEl?.textContent?.includes('페이지를 찾을 수 없')) {
                return 'STSEL'; // 판매중지/삭제
              }

              // Helper: 요소가 실제로 보이는지 확인
              const isVisible = (el) => {
                if (!el) return false;
                const style = window.getComputedStyle(el);
                return style.display !== 'none' &&
                       style.visibility !== 'hidden' &&
                       style.opacity !== '0';
              };

              // 2. 품절 버튼 가시성 체크 (최우선)
              const soldOutBtn = document.querySelector('.btnSoldout');
              if (soldOutBtn && isVisible(soldOutBtn)) {
                return 'SLDOT'; // 품절
              }

              // 3. 재입고 알림 버튼 가시성 체크
              const restockBtn = document.querySelector('.btnReStock');
              if (restockBtn && isVisible(restockBtn)) {
                return 'SLDOT'; // 품절
              }

              // 4. 구매하기 버튼 가시성 체크
              const buyBtn = document.querySelector('.btnBuy, .goods_buy');
              const cartBtn = document.querySelector('.btnBasket, .goods_cart');
              if ((buyBtn && isVisible(buyBtn)) || (cartBtn && isVisible(cartBtn))) {
                return 'SELNG'; // 판매중
              }

              // 5. 기본값 (정보 부족)
              return 'STSEL'; // 판매중지
            };

            return {
              name: productName,
              brand: brand,
              title_images: thumbnail ? [thumbnail] : [],
              consumer_price: consumerPrice,
              price: price,
              sale_status: detectSaleStatus(),
              _source: 'dom',
              _redirected: false
            };
          }

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 브랜드
  brand:
    source: "brand"
    type: "string"
    required: false

  # 썸네일
  thumbnail:
    source: "title_images[0]"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "sold_out"     # 품절
      STSEL: "off_sale"     # 판매중지

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "올리브영 플랫폼 rate limiting"
