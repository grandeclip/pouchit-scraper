# 올리브영(Oliveyoung) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: oliveyoung
name: "올리브영"
baseUrl: "https://www.oliveyoung.co.kr"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 플랫폼별 설정 (Platform-specific Settings)
platform_settings:
  # Desktop 페이지 감지 및 새로고침 활성화
  requiresDesktopDetection: true

  # Desktop 감지 Timeout 설정
  desktopDetection:
    reloadTimeout: 30000      # 새로고침 timeout (ms)
    rerenderWaitTime: 1000    # 재렌더링 대기 시간 (ms)

    # Mobile/Desktop 레이아웃 감지 셀렉터
    mobileSelectors:
      - ".swiper-slide"
      - ".info-group__title"

    desktopSelectors:
      - ".prd_detail_top"
      - "#Contents"
      - ".prd_detail"

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 3000
  POPUP_REMOVAL_WAIT_MS: 1000

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지 이동
        - action: "navigate"
          url: "https://m.oliveyoung.co.kr/m/goods/getGoodsDetail.do?goodsNo=${goodsId}"
          waitUntil: "domcontentloaded"
          timeout: 30000
          description: "상품 상세 페이지 접속 (모바일)"

        # Step 1.5: 페이지 렌더링 대기 (가격 정보 포함)
        - action: "wait"
          timeout: 3000
          description: "페이지 렌더링 대기 (가격 정보 로드)"

        # Step 2: 상단 배너/팝업 제거
        - action: "evaluate"
          script: |
            () => {
              // 쿠폰 배너, 광고 배너 제거
              const banners = document.querySelectorAll('.banner, .popup, .modal, .coupon-banner, [class*="banner"], [class*="popup"]');
              banners.forEach(el => el.remove());

              // z-index 높은 overlay 제거
              const allElements = document.querySelectorAll('*');
              allElements.forEach(el => {
                const zIndex = parseInt(window.getComputedStyle(el).zIndex);
                if (zIndex > 100) {
                  el.remove();
                }
              });
            }
          description: "상단 배너/팝업 제거"

        # Step 3: 메인 이미지 완전 로드 대기 (실제 표시 이미지)
        - action: "evaluate"
          script: |
            async () => {
              window.scrollTo(0, 0);

              // Swiper 활성 슬라이드의 메인 이미지 대기
              const waitForImage = async () => {
                const maxWait = 5000; // 5초
                const startTime = Date.now();

                while (Date.now() - startTime < maxWait) {
                  const activeSlide = document.querySelector('.swiper-slide-active');
                  const mainImg = activeSlide?.querySelector('img');

                  if (mainImg && mainImg.complete && mainImg.naturalHeight > 0) {
                    // 이미지 로드 완료 + 실제 크기 확인
                    const currentSrc = mainImg.currentSrc || mainImg.src;
                    if (currentSrc && currentSrc.includes('oliveyoung.co.kr')) {
                      return true;
                    }
                  }

                  await new Promise(resolve => setTimeout(resolve, 200));
                }
                return true;
              };

              return await waitForImage();
            }
          description: "메인 이미지 로드 완료 대기"

        # Step 4: User-Agent 및 페이지 타입 확인 (디버깅)
        - action: "evaluate"
          script: |
            () => {
              const ua = navigator.userAgent;
              const isMobileUA = /Mobile|iPhone|Android/i.test(ua);
              const pathname = window.location.pathname;
              const isMobilePath = pathname.includes('/m/goods/');

              // Mobile/Desktop DOM 요소 감지
              const hasMobileLayout = !!document.querySelector('.swiper-slide, .info-group__title');
              const hasDesktopLayout = !!document.querySelector('.prd_detail_top, #Contents, .prd_detail');

              console.log('=== Page Info ===');
              console.log('User-Agent:', ua);
              console.log('Is Mobile UA:', isMobileUA);
              console.log('URL:', window.location.href);
              console.log('Pathname:', pathname);
              console.log('Is Mobile Path:', isMobilePath);
              console.log('Viewport:', window.innerWidth, 'x', window.innerHeight);
              console.log('Has Mobile Layout:', hasMobileLayout);
              console.log('Has Desktop Layout:', hasDesktopLayout);

              // 경고 출력
              if (!isMobileUA) {
                console.warn('⚠️ Desktop User-Agent 감지!');
              }
              if (hasDesktopLayout && !hasMobileLayout) {
                console.warn('⚠️ Desktop Layout 감지! (새로고침 필요)');
              }

              return {
                userAgent: ua,
                isMobileUA,
                pathname,
                isMobilePath,
                viewport: { width: window.innerWidth, height: window.innerHeight },
                hasMobileLayout,
                hasDesktopLayout
              };
            }
          description: "User-Agent 및 페이지 타입 확인"

      # 데이터 추출 전략
      extraction:
        # OliveyoungExtractor 클래스 사용 (TypeScript 구현)
        extractor: "oliveyoung"
        description: "OliveyoungExtractor를 통한 Facade Pattern 기반 추출"

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 브랜드
  brand:
    source: "brand"
    type: "string"
    required: false

  # 썸네일
  thumbnail:
    source: "title_images[0]"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "off_sale"     # 품절 (일시품절 포함)
      STSEL: "off_sale"     # 판매중지 (상품 없음 포함)

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "올리브영 플랫폼 rate limiting"

  # Concurrency Settings (병렬 처리 설정)
  concurrency:
    max: 10        # 최대 병렬 개수 (리소스 제한)
    default: 4     # 기본 병렬 개수 (점진적 증가 권장: 1 → 4 → 8)
    description: "배치 병렬 처리 설정 (예: 800개 기준 8병렬 → 8.3분, 리소스 모니터링 후 조정)"
