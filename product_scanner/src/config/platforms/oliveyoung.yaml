# 올리브영(Oliveyoung) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: oliveyoung
name: "올리브영"
baseUrl: "https://m.oliveyoung.co.kr"

# URL 템플릿 (Phase 2: Extract Service)
urlTemplates:
  productDetail: "https://m.oliveyoung.co.kr/m/goods/getGoodsDetail.do?goodsNo=${productId}"

# 상품 ID 추출 패턴
productIdPattern:
  regex: "goodsNo=([A-Z0-9]+)"
  group: 1

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 플랫폼별 설정 (Platform-specific Settings)
platform_settings:
  # Desktop 페이지 감지 및 새로고침 활성화
  requiresDesktopDetection: true

  # URL 변환 규칙 (Desktop -> Mobile)
  urlTransformation:
    - type: "regex_replace"
      pattern: "://www\\.oliveyoung\\.co\\.kr/store/G\\.do"
      replacement: "://m.oliveyoung.co.kr/m/goods/getGoodsDetail.do"
    - type: "regex_replace"
      pattern: "://www\\.oliveyoung\\.co\\.kr/store/goods/getGoodsDetail\\.do"
      replacement: "://m.oliveyoung.co.kr/m/goods/getGoodsDetail.do"

  # Desktop 감지 Timeout 설정
  desktopDetection:
    reloadTimeout: 30000      # 새로고침 timeout (ms)
    rerenderWaitTime: 1000    # 재렌더링 대기 시간 (ms)

# 공통 Selectors (TypeScript에서 참조)
selectors:
  productName:
    - ".info-group__title"  # 1순위: Mobile
    - ".prd_name"  # 2순위: Desktop
    - '[class*="goods"][class*="name"]'  # 3순위
    - '[class*="product"][class*="name"]'  # 4순위
    - '[class*="title"]'  # 5순위
    - "h1"  # 6순위
    - ".goods_name"  # 7순위

  price:
    - ".info-group__price"
    - ".price"
    - '[class*="price"]'  # 큰따옴표로 통일
    - ".prd_price"
  
  saleStatus:
    mobileBuy: "#publBtnBuy, #publBtnBasket, .btnBuy, .btn-buy, .btnBasket, .btn_basket"
    mobileRestock: ".btnReStock, .restock-alert"
    desktopBuy: ".btnBuy"
    desktopBasket: ".btnBasket"
    desktopSoldout: ".btnSoldout"
    errorPage: ".error_title"
  
  layout:
    mobile:
      - ".swiper-slide"
      - ".info-group__title"
    desktop:
      - ".prd_detail_top"
      - "#Contents"
      - ".prd_detail"
  
  images:
    main: ".swiper-slide-active img"
  
  brand:
    - ".top-utils__brand-link"
    - ".prd_brand"
    - '[class*="brand"]'  # 큰따옴표로 통일
    - ".brand-name"

  thumbnail:
    - ".swiper-slide-active img"
    - ".swiper-slide img"
    - ".prd_img img"
    - "#mainImg"
    - "img"

  banners:
    - ".banner"
    - ".popup"
    - ".modal"
    - ".coupon-banner"
    - '[class*="banner"]'  # 큰따옴표로 통일
    - '[class*="popup"]'  # 큰따옴표로 통일

# 상수 정의 (Constants)
constants:
  # Navigation Timeout (strategies에서 사용)
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 3000
  POPUP_REMOVAL_WAIT_MS: 1000

  # Extractor Settings (TypeScript에서 참조)
  Z_INDEX_OVERLAY_THRESHOLD: 100
  MAIN_IMAGE_WAIT_MS: 5000
  IMAGE_POLL_INTERVAL_MS: 200
  MIN_PRODUCT_NAME_LENGTH: 3

  # 모바일 뷰포트 설정 (strategies에서 사용)
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent (strategies에서 사용)
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 버튼 텍스트 패턴 (Sale Status Detection)
button_text_patterns:
  in_stock:
    - "바로구매"
    - "구매하기"
    - "장바구니"
  out_of_stock:
    - "일시품절"
  sold_out:
    - "품절"
  discontinued:
    - "전시기간"
    - "판매중지"
    - "단종"

# 에러 메시지 패턴 (Error Detection)
# 실전 검증됨 (OliveyoungSaleStatusExtractor, OliveyoungMetadataExtractor)
error_messages:
  # 404 에러 메시지
  - "상품을 찾을 수 없습니다"
  - "상품을 찾을 수 없어요"
  - "페이지를 찾을 수 없습니다"
  # 판매 중지 메시지
  - "판매종료"
  - "판매 중지"

# URL 패턴 (Error Detection)
error_url_patterns:
  - "invalid.do"
  - "nogoods"

# 썸네일 제외 패턴
thumbnail_exclusions:
  - "options/item"

# 상품번호 정규식
product_number_pattern: "A\\d{12}"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지 이동
        - action: "navigate"
          url: "https://m.oliveyoung.co.kr/m/goods/getGoodsDetail.do?goodsNo=${goodsId}"
          waitUntil: "domcontentloaded"
          timeout: 30000
          description: "상품 상세 페이지 접속 (모바일)"

        # Step 1.5: 페이지 렌더링 대기 (가격 정보 포함)
        - action: "wait"
          timeout: 3000
          description: "페이지 렌더링 대기 (가격 정보 로드)"

        # Step 2-4: 페이지 전처리 (OliveyoungExtractor.preparePage()에서 처리)
        # - 배너/팝업 제거
        # - 메인 이미지 로드 대기
        # - 페이지 타입 확인 (Mobile/Desktop)

      # 데이터 추출 전략
      extraction:
        # OliveyoungExtractor 클래스 사용 (TypeScript 구현)
        extractor: "oliveyoung"
        description: "OliveyoungExtractor를 통한 Facade Pattern 기반 추출"

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 브랜드
  brand:
    source: "brand"
    type: "string"
    required: false

  # 썸네일
  thumbnail:
    source: "title_images[0]"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "off_sale"     # 품절 (일시품절 포함)
      STSEL: "off_sale"     # 판매중지 (상품 없음 포함)

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Supabase 업데이트 예외 설정
# 특정 필드의 업데이트를 스킵하도록 설정
update_exclusions:
  # 스킵할 필드 목록
  skip_fields:
    # - thumbnail      # 썸네일 추출 로직 개선 필요 (임시 방어)
    # - original_price # 정가 정보 추출 오류 (임시 방어)
  # 사유
  reason: "올리브영 썸네일/정가 추출 로직 개선 후 제거 예정"

# Workflow 설정
workflow:
  # Batch Settings (배치 분할 설정)
  batch_size: 20     # 배치당 상품 수

  # Rate Limiting (요청 간격 제어)
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "올리브영 플랫폼 rate limiting"

  # Concurrency Settings (배치 내 병렬 처리)
  concurrency:
    max: 10        # 최대 병렬 개수 (리소스 제한)
    default: 4     # 기본 병렬 개수 - pLimit으로 배치 내 병렬 처리
    description: "Playwright 병렬 스캔 (예: batch_size=20, concurrency=4 → 5 라운드)"
