# 올리브영(Oliveyoung) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: oliveyoung
name: "올리브영"
baseUrl: "https://www.oliveyoung.co.kr"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 플랫폼별 설정 (Platform-specific Settings)
platform_settings:
  # Desktop 페이지 감지 및 새로고침 활성화
  requiresDesktopDetection: true

  # Desktop 감지 Timeout 설정
  desktopDetection:
    reloadTimeout: 30000      # 새로고침 timeout (ms)
    rerenderWaitTime: 1000    # 재렌더링 대기 시간 (ms)

    # Mobile/Desktop 레이아웃 감지 셀렉터
    mobileSelectors:
      - ".swiper-slide"
      - ".info-group__title"

    desktopSelectors:
      - ".prd_detail_top"
      - "#Contents"
      - ".prd_detail"

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 3000
  POPUP_REMOVAL_WAIT_MS: 1000

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지 이동
        - action: "navigate"
          url: "https://m.oliveyoung.co.kr/m/goods/getGoodsDetail.do?goodsNo=${goodsId}"
          waitUntil: "domcontentloaded"
          timeout: 30000
          description: "상품 상세 페이지 접속 (모바일)"

        # Step 2: 상단 배너/팝업 제거
        - action: "evaluate"
          script: |
            () => {
              // 쿠폰 배너, 광고 배너 제거
              const banners = document.querySelectorAll('.banner, .popup, .modal, .coupon-banner, [class*="banner"], [class*="popup"]');
              banners.forEach(el => el.remove());

              // z-index 높은 overlay 제거
              const allElements = document.querySelectorAll('*');
              allElements.forEach(el => {
                const zIndex = parseInt(window.getComputedStyle(el).zIndex);
                if (zIndex > 100) {
                  el.remove();
                }
              });
            }
          description: "상단 배너/팝업 제거"

        # Step 3: 메인 이미지 완전 로드 대기 (실제 표시 이미지)
        - action: "evaluate"
          script: |
            async () => {
              window.scrollTo(0, 0);

              // Swiper 활성 슬라이드의 메인 이미지 대기
              const waitForImage = async () => {
                const maxWait = 5000; // 5초
                const startTime = Date.now();

                while (Date.now() - startTime < maxWait) {
                  const activeSlide = document.querySelector('.swiper-slide-active');
                  const mainImg = activeSlide?.querySelector('img');

                  if (mainImg && mainImg.complete && mainImg.naturalHeight > 0) {
                    // 이미지 로드 완료 + 실제 크기 확인
                    const currentSrc = mainImg.currentSrc || mainImg.src;
                    if (currentSrc && currentSrc.includes('oliveyoung.co.kr')) {
                      return true;
                    }
                  }

                  await new Promise(resolve => setTimeout(resolve, 200));
                }
                return true;
              };

              return await waitForImage();
            }
          description: "메인 이미지 로드 완료 대기"

        # Step 4: User-Agent 및 페이지 타입 확인 (디버깅)
        - action: "evaluate"
          script: |
            () => {
              const ua = navigator.userAgent;
              const isMobileUA = /Mobile|iPhone|Android/i.test(ua);
              const pathname = window.location.pathname;
              const isMobilePath = pathname.includes('/m/goods/');

              // Mobile/Desktop DOM 요소 감지
              const hasMobileLayout = !!document.querySelector('.swiper-slide, .info-group__title');
              const hasDesktopLayout = !!document.querySelector('.prd_detail_top, #Contents, .prd_detail');

              console.log('=== Page Info ===');
              console.log('User-Agent:', ua);
              console.log('Is Mobile UA:', isMobileUA);
              console.log('URL:', window.location.href);
              console.log('Pathname:', pathname);
              console.log('Is Mobile Path:', isMobilePath);
              console.log('Viewport:', window.innerWidth, 'x', window.innerHeight);
              console.log('Has Mobile Layout:', hasMobileLayout);
              console.log('Has Desktop Layout:', hasDesktopLayout);

              // 경고 출력
              if (!isMobileUA) {
                console.warn('⚠️ Desktop User-Agent 감지!');
              }
              if (hasDesktopLayout && !hasMobileLayout) {
                console.warn('⚠️ Desktop Layout 감지! (새로고침 필요)');
              }

              return {
                userAgent: ua,
                isMobileUA,
                pathname,
                isMobilePath,
                viewport: { width: window.innerWidth, height: window.innerHeight },
                hasMobileLayout,
                hasDesktopLayout
              };
            }
          description: "User-Agent 및 페이지 타입 확인"

      # 데이터 추출 전략
      extraction:
        method: "evaluate"
        description: "모바일 DOM에서 상품 정보 추출 (Network에서 thumbnail 자동 캡처)"
        script: |
          () => {
            // Helper Functions
            const querySelector = (mobileSelector, desktopSelector) => {
              return document.querySelector(mobileSelector) || document.querySelector(desktopSelector);
            };

            const extractNumbers = (text) => {
              const matches = text.match(/(\d{1,3}(?:,\d{3})*)/g);
              return matches ? matches.map(m => parseInt(m.replace(/,/g, ''))) : [];
            };

            const hasButtonWithText = (keywords) => {
              const buttons = Array.from(document.querySelectorAll('button'));
              return buttons.some(btn =>
                keywords.some(keyword => btn.textContent?.includes(keyword)) &&
                window.getComputedStyle(btn).display !== 'none'
              );
            };

            const isVisible = (el) => {
              return window.getComputedStyle(el).display !== 'none';
            };

            try {
              // 모바일 페이지로 리다이렉트되었는지 확인
              const isMobilePage = window.location.pathname.includes('/m/goods/');

              // ===== Data Extraction =====

              // 상품명 추출 (Hybrid - 다양한 selector 시도)
              const getProductName = () => {
                const selectors = [
                  '.info-group__title',           // 1순위: Mobile 기본
                  '.prd_name',                     // 2순위: Desktop
                  '[class*="goods"][class*="name"]', // 3순위: goods_name 등
                  '[class*="product"][class*="name"]', // 4순위: product_name 등
                  '[class*="title"]',              // 5순위: title 포함
                  'h1',                            // 6순위: h1 태그
                  '.goods_name',                   // 7순위: 직접 클래스명
                ];

                for (const selector of selectors) {
                  const el = document.querySelector(selector);
                  if (el) {
                    const text = el.textContent?.trim() || '';
                    // 유효한 상품명 조건: 3글자 이상
                    if (text && text.length >= 3) {
                      return text;
                    }
                  }
                }

                return '';
              };

              const productName = getProductName();

              // 상품 정보 없음 체크
              if (!productName) {
                return {
                  name: '삭제된 상품',
                  brand: '',
                  title_images: ['https://via.placeholder.com/1x1'],
                  consumer_price: 0,
                  price: 0,
                  sale_status: 'STSEL',
                  _source: 'not_found',
                  _redirected: true,
                  _error: 'Product name not found'
                };
              }

              // 브랜드 추출 (Hybrid)
              const getBrand = () => {
                const selectors = [
                  '.top-utils__brand-link',        // 1순위: Mobile
                  '.prd_brand',                     // 2순위: Desktop
                  '[class*="brand"]',               // 3순위: brand 포함
                  '.brand-name',                    // 4순위
                ];

                for (const selector of selectors) {
                  const el = document.querySelector(selector);
                  if (el) {
                    const text = el.textContent?.trim() || '';
                    if (text) return text;
                  }
                }

                return '';
              };

              const brand = getBrand();

              // 메인 썸네일 추출: Hybrid (Mobile + Desktop 지원)
              const getDisplayedThumbnail = () => {
                // 1순위: Mobile Swiper 활성 슬라이드
                const activeSlide = document.querySelector('.swiper-slide-active');
                if (activeSlide) {
                  const activeImg = activeSlide.querySelector('img');
                  if (activeImg) {
                    const displayedSrc = activeImg.currentSrc || activeImg.src;
                    if (displayedSrc && !displayedSrc.includes('options/item')) {
                      return displayedSrc;
                    }
                  }
                }

                // 2순위: Mobile 첫 번째 슬라이드
                const firstSlide = document.querySelector('.swiper-slide');
                if (firstSlide) {
                  const firstImg = firstSlide.querySelector('img');
                  if (firstImg) {
                    const displayedSrc = firstImg.currentSrc || firstImg.src;
                    if (displayedSrc && !displayedSrc.includes('options/item')) {
                      return displayedSrc;
                    }
                  }
                }

                // 3순위: Desktop 메인 이미지 (다양한 selector 시도)
                const desktopSelectors = [
                  '.prd_img img',           // 상품 메인 이미지
                  '.detail_img img',        // 상세 이미지
                  '.goods_img img',         // 상품 이미지
                  '#mainImg',               // ID 기반
                  '.prd_detail_img img',    // 상세 페이지 이미지
                  '.item_photo_slide img'   // 슬라이드 이미지
                ];

                for (const selector of desktopSelectors) {
                  const desktopImg = document.querySelector(selector);
                  if (desktopImg && desktopImg.src && !desktopImg.src.includes('options/item')) {
                    return desktopImg.src;
                  }
                }

                // 4순위: 모든 슬라이드 검색 (Mobile fallback)
                const allSlides = document.querySelectorAll('.swiper-slide img');
                for (const img of allSlides) {
                  const src = img.currentSrc || img.src;
                  if (src && !src.includes('options/item') && img.complete) {
                    return src;
                  }
                }

                // 5순위: 가장 큰 이미지 (최후 수단)
                const allImages = document.querySelectorAll('img');
                let largestImg = null;
                let maxSize = 0;

                allImages.forEach(img => {
                  if (img.complete && img.naturalWidth > 0 && img.src && img.src.includes('oliveyoung.co.kr')) {
                    const size = img.naturalWidth * img.naturalHeight;
                    if (size > maxSize && !img.src.includes('options/item')) {
                      maxSize = size;
                      largestImg = img;
                    }
                  }
                });

                return largestImg?.src || '';
              };

              const thumbnailRaw = getDisplayedThumbnail();
              const thumbnail = thumbnailRaw.split('?')[0]; // 쿼리 제거

              // 가격 추출 로직 (Hybrid)
              const getPriceContainer = () => {
                const selectors = [
                  '.info-group__price',            // 1순위: Mobile
                  '.price',                         // 2순위: Desktop
                  '[class*="price"]',               // 3순위: price 포함
                  '.prd_price',                     // 4순위
                ];

                for (const selector of selectors) {
                  const el = document.querySelector(selector);
                  if (el && el.textContent?.trim()) {
                    return el;
                  }
                }

                return null;
              };

              const priceContainerEl = getPriceContainer();

              // 할인율 요소 확인 및 제거
              const emRateEl = priceContainerEl?.querySelector('em.rate') || priceContainerEl?.querySelector('em');
              const hasDiscountRate = emRateEl !== null;

              // 할인율 텍스트 제거한 가격 텍스트
              let priceText = priceContainerEl?.textContent?.trim() || '';
              if (hasDiscountRate && emRateEl) {
                const rateText = emRateEl.textContent || '';
                priceText = priceText.replace(rateText, '');
              }

              const priceNumbers = extractNumbers(priceText);

              let consumerPrice = 0;
              let price = 0;

              if (priceNumbers.length === 0) {
                // 가격 정보 없음
                consumerPrice = 0;
                price = 0;
              } else if (hasDiscountRate && priceNumbers.length >= 2) {
                // 할인율 있음 → 첫번째=정가, 마지막=판매가
                consumerPrice = priceNumbers[0];
                price = priceNumbers[priceNumbers.length - 1];
              } else {
                // 할인율 없음 → 1개만 존재 → 정가=판매가
                consumerPrice = priceNumbers[0];
                price = priceNumbers[0];
              }

              // ===== Sale Status Detection =====

              const detectSaleStatus = () => {
                // 1. 상품 정보 없음 체크 (not_found)
                if (!productName || productName === '삭제된 상품') {
                  return 'STSEL'; // not_found → off_sale
                }

                // 2. 페이지 에러 체크 (404 등)
                const errorEl = document.querySelector('h1');
                if (errorEl?.textContent?.includes('페이지를 찾을 수 없')) {
                  return 'STSEL'; // not_found → off_sale
                }

                // 3. Mobile 구매 버튼 그룹 체크 (.goods-buy__bottom-group)
                const buyBtnEl = document.querySelector('#publBtnBuy');
                if (buyBtnEl) {
                  const btnText = buyBtnEl.textContent?.trim() || '';
                  const isDisabled = buyBtnEl.disabled || buyBtnEl.hasAttribute('disabled');

                  // 3-1. 일시품절 (버튼 disabled + 텍스트="일시품절")
                  if (isDisabled && btnText.includes('일시품절')) {
                    return 'SLDOT'; // out_of_stock → sold_out
                  }

                  // 3-2. 바로구매 (버튼 활성 + 텍스트="바로구매")
                  if (!isDisabled && btnText.includes('바로구매')) {
                    return 'SELNG'; // on_sale
                  }

                  // 3-3. 전시기간 아님
                  if (btnText.includes('전시기간이 아닙니다')) {
                    return 'STSEL'; // off_sale
                  }
                }

                // 4. Desktop 구매 버튼 체크
                const buyBtn = document.querySelector('.btnBuy');
                const cartBtn = document.querySelector('.btnBasket');
                if ((buyBtn && isVisible(buyBtn)) || (cartBtn && isVisible(cartBtn))) {
                  return 'SELNG';
                }

                // 5. Mobile 재입고 알림 버튼 체크 (일시품절 보조 검증)
                if (hasButtonWithText(['재입고'])) {
                  return 'SLDOT'; // out_of_stock
                }

                // 6. Desktop 품절 버튼 체크
                const soldOutBtn = document.querySelector('.btnSoldout');
                const restockBtn = document.querySelector('.btnReStock');
                if ((soldOutBtn && isVisible(soldOutBtn)) || (restockBtn && isVisible(restockBtn))) {
                  return 'SLDOT';
                }

                // 7. 가격 존재 시 판매중으로 간주
                if (price > 0) {
                  return 'SELNG';
                }

                // 8. 기본값 (판매중지)
                return 'STSEL';
              };

              return {
                name: productName,
                brand: brand,
                title_images: thumbnail ? [thumbnail] : [],
                consumer_price: consumerPrice,
                price: price,
                sale_status: detectSaleStatus(),
                _source: 'mobile_dom',
                _redirected: isMobilePage,
                _error: null
              };

            } catch (error) {
              // 추출 실패 시 에러 정보 포함하여 반환
              return {
                name: '추출 실패',
                brand: '',
                title_images: ['https://via.placeholder.com/1x1'],
                consumer_price: 0,
                price: 0,
                sale_status: 'STSEL',
                _source: 'error',
                _redirected: false,
                _error: error.message || String(error)
              };
            }
          }

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 브랜드
  brand:
    source: "brand"
    type: "string"
    required: false

  # 썸네일
  thumbnail:
    source: "title_images[0]"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "off_sale"     # 품절 (일시품절 포함)
      STSEL: "off_sale"     # 판매중지 (상품 없음 포함)

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "올리브영 플랫폼 rate limiting"

  # Concurrency Settings (병렬 처리 설정)
  concurrency:
    max: 10        # 최대 병렬 개수 (리소스 제한)
    default: 4     # 기본 병렬 개수 (점진적 증가 권장: 1 → 4 → 8)
    description: "배치 병렬 처리 설정 (예: 800개 기준 8병렬 → 8.3분, 리소스 모니터링 후 조정)"
