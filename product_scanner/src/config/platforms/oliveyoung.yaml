# 올리브영(Oliveyoung) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: oliveyoung
name: "올리브영"
baseUrl: "https://www.oliveyoung.co.kr"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 3000
  POPUP_REMOVAL_WAIT_MS: 1000

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://www.oliveyoung.co.kr/store/goods/getGoodsDetail.do?goodsNo=${goodsId}"
          waitUntil: "domcontentloaded"
          timeout: 30000
          description: "상품 상세 페이지 접속"

        # Step 2: 앱 전환 팝업 제거 (모바일)
        - action: "evaluate"
          script: |
            () => {
              // 앱 전환 관련 요소 제거
              const appBanners = document.querySelectorAll('[class*="app"], [class*="download"], [class*="encourage"]');
              appBanners.forEach(el => el.remove());

              // 오버레이 제거
              const overlays = document.querySelectorAll('[class*="overlay"], [class*="modal"]');
              overlays.forEach(el => el.remove());

              // body overflow 복원
              document.body.style.overflow = 'auto';
            }
          description: "앱 전환 팝업 제거"

        # Step 3: 페이지 렌더링 충분히 대기
        - action: "wait"
          timeout: 3000
          description: "페이지 렌더링 대기"

      # 데이터 추출 전략
      extraction:
        method: "evaluate"
        description: "모바일 DOM에서 상품 정보 추출"
        script: |
          () => {
            // ===== Helper Functions =====

            /**
             * Mobile/Desktop selector fallback
             * @param {string} mobileSelector - Mobile용 CSS selector
             * @param {string} desktopSelector - Desktop fallback selector
             * @returns {Element|null}
             */
            const querySelector = (mobileSelector, desktopSelector) => {
              return document.querySelector(mobileSelector) ||
                     document.querySelector(desktopSelector);
            };

            /**
             * 요소 가시성 체크
             * @param {Element} el - 체크할 DOM 요소
             * @returns {boolean}
             */
            const isVisible = (el) => {
              if (!el) return false;
              const style = window.getComputedStyle(el);
              return style.display !== 'none' &&
                     style.visibility !== 'hidden' &&
                     style.opacity !== '0';
            };

            /**
             * 가격 텍스트 파싱
             * @param {string} text - 가격 텍스트 (예: "25,000원")
             * @returns {number} - 정수형 가격
             */
            const parsePrice = (text) => {
              const match = text.match(/(\d{1,3}(?:,\d{3})*)/);
              return match ? parseInt(match[1].replace(/,/g, '')) : 0;
            };

            /**
             * 버튼 텍스트 포함 여부 체크
             * @param {string[]} keywords - 체크할 키워드 배열
             * @returns {boolean}
             */
            const hasButtonWithText = (keywords) => {
              const buttons = Array.from(document.querySelectorAll('button'));
              return buttons.some(btn =>
                keywords.some(keyword => btn.textContent?.includes(keyword)) &&
                window.getComputedStyle(btn).display !== 'none'
              );
            };

            // ===== Error Handling Wrapper =====

            try {
              // 모바일 페이지로 리다이렉트되었는지 확인
              const isMobilePage = window.location.pathname.includes('/m/goods/');

              // ===== Data Extraction =====

              // 상품명 추출
              const productNameEl = querySelector('.info-group__title', '.prd_name');
              const productName = productNameEl?.textContent?.trim() || '';

              // 상품 정보 없음 체크
              if (!productName) {
                return {
                  name: '삭제된 상품',
                  brand: '',
                  title_images: ['https://via.placeholder.com/1x1'],
                  consumer_price: 0,
                  price: 0,
                  sale_status: 'STSEL',
                  _source: 'not_found',
                  _redirected: true,
                  _error: null
                };
              }

              // 브랜드 추출
              const brandEl = querySelector('.top-utils__brand-link', '.prd_brand');
              const brand = brandEl?.textContent?.trim() || '';

              // 이미지 추출 (Mobile: 제품 이미지 / Desktop: prd_img)
              const imageEl = querySelector('img[alt*="제품"]', '.prd_img img') ||
                              querySelector('img[src*="cfimages/cf-goods"]', '.prd_img img');
              const thumbnailRaw = imageEl?.src || '';
              // URL 정규화: 쿼리 파라미터 제거 (예: ?RS=100x0, ?qt=80 등)
              const thumbnail = thumbnailRaw.split('?')[0];

              // 가격 추출
              const priceEl = querySelector('.info-group__price .price', '.price-2');
              const priceText = priceEl?.textContent?.trim() || '';
              const price = parsePrice(priceText);

              // 정가 추출
              const originalPriceEl = querySelector('.info-group__price .price', '.price-1');
              const originalPriceText = originalPriceEl?.textContent?.trim() || '';
              const consumerPrice = parsePrice(originalPriceText) || price;

              // ===== Sale Status Detection =====

              const detectSaleStatus = () => {
                // 1. 페이지 에러 체크
                const errorEl = document.querySelector('h1');
                if (errorEl?.textContent?.includes('페이지를 찾을 수 없')) {
                  return 'STSEL';
                }

                // 2. Desktop 구매 버튼 체크
                const buyBtn = document.querySelector('.btnBuy');
                const cartBtn = document.querySelector('.btnBasket');
                if ((buyBtn && isVisible(buyBtn)) || (cartBtn && isVisible(cartBtn))) {
                  return 'SELNG';
                }

                // 3. Mobile 구매 버튼 체크
                if (hasButtonWithText(['장바구니', '바로구매', '구매'])) {
                  return 'SELNG';
                }

                // 4. Desktop 품절 버튼 체크
                const soldOutBtn = document.querySelector('.btnSoldout');
                const restockBtn = document.querySelector('.btnReStock');
                if ((soldOutBtn && isVisible(soldOutBtn)) || (restockBtn && isVisible(restockBtn))) {
                  return 'SLDOT';
                }

                // 5. Mobile 품절 텍스트 체크
                if (hasButtonWithText(['품절', '재입고'])) {
                  return 'SLDOT';
                }

                // 6. 가격 존재 시 판매중으로 간주
                if (price > 0) {
                  return 'SELNG';
                }

                // 7. 기본값
                return 'STSEL';
              };

              return {
                name: productName,
                brand: brand,
                title_images: thumbnail ? [thumbnail] : [],
                consumer_price: consumerPrice,
                price: price,
                sale_status: detectSaleStatus(),
                _source: 'mobile_dom',
                _redirected: isMobilePage,
                _error: null
              };

            } catch (error) {
              // 추출 실패 시 에러 정보 포함하여 반환
              return {
                name: '추출 실패',
                brand: '',
                title_images: ['https://via.placeholder.com/1x1'],
                consumer_price: 0,
                price: 0,
                sale_status: 'STSEL',
                _source: 'error',
                _redirected: false,
                _error: error.message || String(error)
              };
            }
          }

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 브랜드
  brand:
    source: "brand"
    type: "string"
    required: false

  # 썸네일
  thumbnail:
    source: "title_images[0]"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "sold_out"     # 품절
      STSEL: "off_sale"     # 판매중지

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "올리브영 플랫폼 rate limiting"

  # Concurrency Settings (병렬 처리 설정)
  concurrency:
    max: 10        # 최대 병렬 개수 (리소스 제한)
    default: 4     # 기본 병렬 개수 (점진적 증가 권장: 1 → 4 → 8)
    description: "배치 병렬 처리 설정 (예: 800개 기준 8병렬 → 8.3분, 리소스 모니터링 후 조정)"
