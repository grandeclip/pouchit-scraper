# 무신사(Musinsa) 플랫폼 설정
# 전략: HTTP API (직접 API 호출)

platform: musinsa
name: "무신사"
baseUrl: "https://goods-detail.musinsa.com"

# API 엔드포인트
endpoints:
  goodsDetail: "${baseUrl}/api2/goods/${goodsId}"

# 스캔 전략 (Strategy Pattern)
strategies:
  # 전략 1: HTTP API (빠르고 효율적)
  - id: "api"
    type: "http"
    priority: 1
    description: "API 기반 데이터 페칭 (권장)"
    http:
      method: GET
      headers:
        # 브라우저 식별 헤더
        User-Agent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        Accept: "*/*"
        Accept-Language: "ko-KR,ko;q=0.9"
        Accept-Encoding: "gzip, deflate, br"
        # CORS 보안 헤더
        Sec-Fetch-Site: "same-site"
        Sec-Fetch-Mode: "cors"
        Sec-Fetch-Dest: "empty"
        Referer: "https://www.musinsa.com/"
      timeout: 10000
      retryCount: 3
      retryDelay: 1000
      requestDelay: 1000

  # 전략 2: Playwright 브라우저 (Fallback - API 차단 시)
  # 현재는 API로 모든 요구사항 충족
  # - id: "browser"
  #   type: "playwright"
  #   priority: 2
  #   description: "브라우저 기반 스크래핑 (Fallback)"
  #   playwright:
  #     headless: true
  #     timeout: 30000
  #     browserOptions:
  #       args:
  #         - "--disable-blink-features=AutomationControlled"
  #     contextOptions:
  #       viewport:
  #         width: 430
  #         height: 932
  #       userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
  #       isMobile: true
  #       hasTouch: true
  #       deviceScaleFactor: 3
  #     navigationSteps:
  #       - action: "navigate"
  #         url: "https://www.musinsa.com/products/${goodsId}"
  #         description: "상품 상세 페이지 접속"
  #       - action: "wait"
  #         timeout: 2000
  #         description: "페이지 렌더링 대기"
  #     extraction:
  #       method: "json_ld_schema"
  #       description: "JSON-LD Schema.org 구조화 데이터 추출"
  #       extractor: "JsonLdSchemaExtractor"
  #       config:
  #         selector: 'script[type="application/ld+json"]'
  #         fallback:
  #           name: "삭제된 상품"
  #           thumbnail: "https://via.placeholder.com/1x1"
  #           price: 0
  #           sale_status: "STSEL"

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "data.goodsNm"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "data.thumbnailImageUrl"
    type: "string"
    required: true
    transform: "addImagePrefix"
    prefix: "https://image.msscdn.net"

  # 정가
  originalPrice:
    source: "data.goodsPrice.normalPrice"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "data.goodsPrice.salePrice"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "data.goodsSaleType"
    type: "enum"
    required: true
    mapping:
      SALE: "on_sale"           # 판매중
      SOLDOUT: "sold_out"       # 품절
      STOP_SALE: "off_sale"     # 판매중지

# 에러 처리
errorHandling:
  # API 에러 응답 처리
  errorField: "meta.errorCode"
  notFoundCodes:
    - "ERROR"
    - "NOT_FOUND"
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# Workflow Rate Limiting
# Node-level rate limiting (상품별 HTTP 요청 간격 제어)
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2500  # 각 상품 스캔 간 대기 시간 (밀리초)
    description: "HTTP request rate limiting per product (applies in MusinsaValidationNode)"
