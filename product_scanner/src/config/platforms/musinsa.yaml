# 무신사(Musinsa) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: musinsa
name: "무신사"
baseUrl: "https://www.musinsa.com"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://www.musinsa.com/products/${goodsId}"
          description: "상품 상세 페이지 접속"

        # Step 2: 앱 다운로드 팝업 제거 (모바일)
        - action: "evaluate"
          script: |
            () => {
              // 앱 전환 관련 요소 제거
              const appBanners = document.querySelectorAll('[class*="app"], [class*="download"], [class*="encourage"]');
              appBanners.forEach(el => el.remove());

              // 오버레이 제거
              const overlays = document.querySelectorAll('[class*="overlay"], [class*="modal"]');
              overlays.forEach(el => el.remove());

              // body overflow 복원
              document.body.style.overflow = 'auto';
            }
          description: "앱 전환 팝업 제거"

        # Step 3: 페이지 로딩 대기
        - action: "wait"
          timeout: 2000
          description: "페이지 렌더링 대기"

      # 데이터 추출 전략 (모바일 - SCRIPT 태그 JSON 파싱)
      extraction:
        method: "evaluate"
        description: "SCRIPT 태그에서 window.__MSS__ JSON 파싱"
        script: |
          () => {
            // Helper: 알람창(dialog) 체크
            const hasInvalidDialog = () => {
              const dialogTexts = ['유효하지 않은 상품', '존재하지 않는', '찾을 수 없'];
              const allText = document.body.innerText;
              return dialogTexts.some(text => allText.includes(text));
            };

            // 1. 삭제된 상품 체크 (알람창 또는 리다이렉트)
            if (hasInvalidDialog() || window.location.pathname === '/') {
              return {
                name: '삭제된 상품',
                title_images: ['https://via.placeholder.com/1x1'],
                consumer_price: 0,
                price: 0,
                sale_status: 'STSEL',
                _source: 'not_found',
                _redirected: true
              };
            }

            // 2. SCRIPT 태그에서 window.__MSS__.product.state 추출
            let productData = null;

            try {
              // SCRIPT 태그 검색
              const scripts = Array.from(document.querySelectorAll('script'));
              const mssScript = scripts.find(s => s.textContent?.includes('window.__MSS__.product.state'));

              if (mssScript) {
                const scriptText = mssScript.textContent || '';

                // "window.__MSS__.product.state = " 이후 JSON 추출
                const match = scriptText.match(/window\.__MSS__\.product\.state\s*=\s*(\{[\s\S]*?\});/);

                if (match && match[1]) {
                  try {
                    productData = JSON.parse(match[1]);
                  } catch (parseError) {
                    console.warn('JSON 파싱 실패:', parseError);
                  }
                }
              }
            } catch (error) {
              console.warn('SCRIPT 태그 파싱 실패:', error);
            }

            if (!productData) {
              return {
                name: '삭제된 상품',
                title_images: ['https://via.placeholder.com/1x1'],
                consumer_price: 0,
                price: 0,
                sale_status: 'STSEL',
                _source: 'script_not_found',
                _redirected: false
              };
            }

            // 3. 상품명
            const productName = productData.goodsNm || '';

            // 4. 썸네일 (URL 정규화)
            const thumbnailUrl = productData.thumbnailImageUrl || '';
            const thumbnail = thumbnailUrl.startsWith('//')
              ? 'https:' + thumbnailUrl
              : thumbnailUrl.startsWith('/')
                ? 'https://image.msscdn.net' + thumbnailUrl
                : thumbnailUrl;

            // 5. 가격 정보
            const goodsPrice = productData.goodsPrice || {};
            const salePrice = goodsPrice.salePrice || 0;
            const normalPrice = goodsPrice.normalPrice || salePrice;

            // 6. 판매 상태
            const detectSaleStatus = () => {
              // productData.isOutOfStock 체크
              if (productData.isOutOfStock === true) {
                return 'SLDOT';
              }

              // 구매하기 버튼 체크 (DOM)
              const buyButtons = Array.from(document.querySelectorAll('button'));
              const buyBtn = buyButtons.find(btn => btn.textContent?.includes('구매하기'));

              if (buyBtn) {
                const isVisible = (el) => {
                  if (!el) return false;
                  const style = window.getComputedStyle(el);
                  return style.display !== 'none' &&
                         style.visibility !== 'hidden' &&
                         style.opacity !== '0';
                };

                if (buyBtn.disabled || !isVisible(buyBtn)) {
                  return 'SLDOT';
                }
                return 'SELNG';
              }

              return 'SLDOT';
            };

            return {
              name: productName,
              title_images: thumbnail ? [thumbnail] : [],
              consumer_price: normalPrice,
              price: salePrice,
              sale_status: detectSaleStatus(),
              _source: 'script_json',
              _redirected: false
            };
          }

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "thumbnail"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "sold_out"     # 품절
      STSEL: "off_sale"     # 판매중지/삭제

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "무신사 플랫폼 rate limiting"

  # Concurrency Settings (병렬 처리 설정)
  concurrency:
    max: 10        # 최대 병렬 개수
    default: 8     # 기본 병렬 개수
    description: "배치 병렬 처리 설정"
