# 무신사(Musinsa) 플랫폼 설정
# 전략: Playwright 브라우저 기반 스크래핑

platform: musinsa
name: "무신사"
baseUrl: "https://www.musinsa.com"

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "브라우저 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 18_5 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/18.5 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 직접 이동
        - action: "navigate"
          url: "https://www.musinsa.com/products/${goodsId}"
          description: "상품 상세 페이지 접속"

        # Step 2: 앱 다운로드 팝업 제거 (모바일)
        - action: "evaluate"
          script: |
            () => {
              // 앱 전환 관련 요소 제거
              const appBanners = document.querySelectorAll('[class*="app"], [class*="download"], [class*="encourage"]');
              appBanners.forEach(el => el.remove());

              // 오버레이 제거
              const overlays = document.querySelectorAll('[class*="overlay"], [class*="modal"]');
              overlays.forEach(el => el.remove());

              // body overflow 복원
              document.body.style.overflow = 'auto';
            }
          description: "앱 전환 팝업 제거"

        # Step 3: 페이지 로딩 대기
        - action: "wait"
          timeout: 2000
          description: "페이지 렌더링 대기"

      # 데이터 추출 전략 (JSON-LD Schema.org 기반)
      extraction:
        method: "json_ld_schema"
        description: "JSON-LD Schema.org 구조화 데이터 추출"
        extractor: "JsonLdSchemaExtractor"
        config:
          selector: 'script[type="application/ld+json"]'
          fallback:
            name: "삭제된 상품"
            thumbnail: "https://via.placeholder.com/1x1"
            price: 0
            sale_status: "STSEL"

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "thumbnail"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "consumer_price"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "price"
    type: "number"
    required: true

  # 판매 상태
  saleStatus:
    source: "sale_status"
    type: "enum"
    required: true
    mapping:
      SELNG: "on_sale"      # 판매중
      SLDOT: "sold_out"     # 품절
      STSEL: "off_sale"     # 판매중지/삭제

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 3000
    description: "무신사 플랫폼 rate limiting"

  # Concurrency Settings (병렬 처리 설정)
  concurrency:
    max: 10        # 최대 병렬 개수
    default: 5     # 기본 병렬 개수
    description: "배치 병렬 처리 설정"

  # Memory Management (메모리 누수 방지)
  memory_management:
    page_rotation_interval: 10     # N개마다 Page 재생성 (메모리 정리)
    context_rotation_interval: 50  # N개마다 Context 재생성 (장기 실행 대비)
    enable_gc_hints: true           # V8 GC 힌트 활성화
    description: "메모리 최적화 설정"
