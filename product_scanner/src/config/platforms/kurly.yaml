# 마켓컬리(Kurly) 플랫폼 설정
# 전략: Next.js __NEXT_DATA__ 파싱 기반 스크래핑

platform: kurly
name: "마켓컬리"
baseUrl: "https://www.kurly.com"

# URL 템플릿 (Phase 2: Extract Service)
urlTemplates:
  productDetail: "https://www.kurly.com/goods/${productId}"

# 상품 ID 추출 패턴
productIdPattern:
  regex: "/goods/(\\d+)"
  group: 1

# 엔드포인트 (Playwright 전용이므로 빈 객체)
endpoints: {}

# 상수 정의 (Constants)
constants:
  # Timeout 설정
  PAGE_LOAD_TIMEOUT_MS: 30000
  RENDER_WAIT_MS: 2000

  # 모바일 뷰포트 설정
  MOBILE_VIEWPORT_WIDTH: 430
  MOBILE_VIEWPORT_HEIGHT: 932
  MOBILE_DEVICE_SCALE: 3

  # User Agent
  MOBILE_USER_AGENT: "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"

  # 상태 메시지 (Magic String 제거)
  NOT_FOUND_MESSAGE: "상품 정보 없음"
  ERROR_MESSAGE: "추출 실패"
  MISSING_NAME_MESSAGE: "상품명 없음"

# 스캔 전략 (Strategy Pattern)
strategies:
  # Playwright 브라우저 전략
  - id: "browser"
    type: "playwright"
    priority: 1
    description: "Next.js __NEXT_DATA__ 파싱 기반 스크래핑"
    playwright:
      headless: true
      timeout: 30000

      # 브라우저 설정 (Stealth 모드)
      browserOptions:
        args:
          - "--disable-blink-features=AutomationControlled"

      # Context 설정 (모바일)
      contextOptions:
        viewport:
          width: 430
          height: 932
        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Mobile/15E148 Safari/604.1"
        isMobile: true
        hasTouch: true
        deviceScaleFactor: 3

      # 네비게이션 전략
      navigationSteps:
        # Step 1: 상품 상세 페이지로 이동
        - action: "navigate"
          url: "https://www.kurly.com/goods/${productId}"
          waitUntil: "domcontentloaded"
          timeout: 30000
          description: "상품 상세 페이지 접속"

        # Step 2: __NEXT_DATA__ 로딩 대기
        - action: "wait"
          timeout: 2000
          description: "__NEXT_DATA__ 렌더링 대기"

      # 데이터 추출 전략 (KurlyExtractor 사용)
      extraction:
        extractor: "kurly"
        description: "KurlyExtractor - Next.js __NEXT_DATA__ 파싱 기반"

# 필드 매핑 규칙
fieldMapping:
  # 상품명
  productName:
    source: "name"
    type: "string"
    required: true

  # 썸네일
  thumbnail:
    source: "mainImageUrl"
    type: "string"
    required: true
    normalize: true

  # 정가
  originalPrice:
    source: "retailPrice"
    type: "number"
    required: true

  # 판매가
  discountedPrice:
    source: "discountedPrice"
    type: "number"
    required: true

  # 판매 상태 (시스템 정책: sold_out → off_sale)
  saleStatus:
    source: "status"
    type: "enum"
    required: true
    mapping:
      ON_SALE: "on_sale"          # 판매중
      SOLD_OUT: "off_sale"        # 품절 → 시스템 정책상 off_sale
      INFO_CHANGED: "off_sale"    # 상품정보변경
      NOT_FOUND: "off_sale"       # 상품정보없음
      ERROR: "off_sale"           # 추출 실패

# 검증 규칙
validation:
  priceThreshold: 0.10
  normalizeUrls: true
  strictMode: false

# 에러 처리
errorHandling:
  notFound: "product_deleted"
  rateLimitDelay: 2000
  serverErrorRetry: true

# Workflow Rate Limiting
workflow:
  rate_limit:
    enabled: true
    wait_time_ms: 2000
    description: "컬리 플랫폼 rate limiting"

  # Concurrency Settings
  concurrency:
    max: 10
    default: 4
    description: "배치 병렬 처리 설정"
