mall: ably
name: "ì—ì´ë¸”ë¦¬"
baseUrl: "https://m.a-bly.com"
searchUrl: "${baseUrl}/search"

# ìµœëŒ€ ê²°ê³¼ ìˆ˜ ì œí•œ
maxResults: 5

# ì—ì´ë¸”ë¦¬ ì „ìš© ì„¤ì •
ably:
  maxProductsToCheck: 5  # ìƒí’ˆ URL ì¶”ì¶œì„ ìœ„í•´ í´ë¦­í•  ìµœëŒ€ ìƒí’ˆ ìˆ˜

# ë¸Œë¼ìš°ì € ì„¤ì • (ëª¨ë°”ì¼)
browser:
  headless: true
  args:
    - "--no-sandbox"
    - "--disable-setuid-sandbox"
    - "--disable-dev-shm-usage"
    - "--disable-accelerated-2d-canvas"
    - "--no-first-run"
    - "--no-zygote"
    - "--disable-gpu"
  viewport:
    width: 375
    height: 812
  # userAgentëŠ” config/userAgents/userAgents.yamlì—ì„œ ëœë¤ ì„ íƒë¨
  # í• ë‹¹ëœ User-Agents: safari_iphone_ios16, safari_iphone_ios17

# ë„¤ë¹„ê²Œì´ì…˜ ìˆœì„œ
navigation:
  steps:
    # 1. ê²€ìƒ‰ í˜ì´ì§€ ì´ë™
    - action: goto
      url: "${searchUrl}"
      waitUntil: domcontentloaded
      timeout: 30000
    - action: wait
      duration: 1000

    # 2. ê²€ìƒ‰ì–´ ì…ë ¥ (ì²« ë²ˆì§¸ textbox)
    - action: fill
      selector: 'input[type="text"]'
      value: "${brand} ${productName}"
      timeout: 10000

    # 3. Enter í‚¤ ì…ë ¥
    - action: press
      selector: 'input[type="text"]'
      key: "Enter"
      timeout: 10000

    # 4. ê²€ìƒ‰ ê²°ê³¼ ë¡œë”© ëŒ€ê¸° (optional: íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ ê³„ì† ì§„í–‰)
    - action: waitForLoadState
      state: domcontentloaded
      timeout: 30000
      optional: true

    # 5. ìƒí’ˆ ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸°
    - action: wait
      duration: 2000

    # ğŸ†• 6. ìƒí’ˆ í´ë¦­í•˜ì—¬ URL ì¶”ì¶œ (SPA íŠ¹í™” ì•¡ì…˜)
    - action: clickAndExtractUrl
      containerSelector: 'main picture img[src*="cloudfront"]'
      maxProducts: 5  # ìµœëŒ€ 5ê°œ ìƒí’ˆ ì²˜ë¦¬
      waitAfterClick: 1000
      waitAfterBack: 500
      storeIn: 'productUrls'

# ë°ì´í„° ì¶”ì¶œ ê·œì¹™
extraction:
  type: evaluate
  script: |
    (function(brand, productName, productUrls) {
      // ë””ë²„ê¹…: ì¸ì í™•ì¸
      if (!Array.isArray(productUrls) || productUrls.length === 0) {
        // URL ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
        return [];
      }

      const results = [];
      const MAX_RESULTS = 5; // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ
      const seenUrls = new Set(); // URL ì¤‘ë³µ ì²´í¬ìš©

      // ìƒí’ˆ ì»¨í…Œì´ë„ˆ ì°¾ê¸° (cloudfront CDN ì´ë¯¸ì§€ë“¤)
      const containers = document.querySelectorAll('main picture img[src*="cloudfront"]');

      containers.forEach((img, index) => {
        // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
        if (results.length >= MAX_RESULTS) return;

        try {
          // URLì´ ì¶”ì¶œë˜ì§€ ì•Šì€ ìƒí’ˆì€ ìŠ¤í‚µ
          if (index >= productUrls.length) {
            return;
          }

          const productUrl = productUrls[index];

          // ìƒí’ˆ ID ì¶”ì¶œ (URLì—ì„œ)
          const productIdMatch = productUrl.match(/\/goods\/(\d+)/);
          const productId = productIdMatch ? productIdMatch[1] : '';

          if (!productId) {
            return;
          }

          // ì¸ë„¤ì¼
          const thumbnail = img.getAttribute('src') || '';

          // ë¶€ëª¨ ìš”ì†Œì—ì„œ ì •ë³´ ì¶”ì¶œ
          // img â†’ picture â†’ div Ã— 4 (depth 6) = ìƒí’ˆ ì¹´ë“œ
          let productCard = img;
          for (let i = 0; i < 6; i++) {
            productCard = productCard.parentElement;
            if (!productCard) {
              return;
            }
          }

          // productCard ë‚´ì˜ ëª¨ë“  paragraphë“¤ì—ì„œ ê°€ê²©ê³¼ í• ì¸ìœ¨ ì¶”ì¶œ
          const allParagraphs = productCard.querySelectorAll('p');
          let salePrice = 0;
          let originalPrice = null;
          let discountRate = null;

          // paragraphë“¤ì—ì„œ ê°€ê²©ê³¼ í• ì¸ìœ¨ ì¶”ì¶œ
          for (const p of allParagraphs) {
            const text = p.textContent?.trim() || '';

            // í• ì¸ìœ¨ ì¶”ì¶œ (ì˜ˆ: "13%", "19%")
            if (text.match(/^\d{1,2}%$/)) {
              discountRate = parseInt(text.replace('%', ''), 10);
              continue;
            }

            // ê°€ê²© ì¶”ì¶œ (ì½¤ë§ˆ í¬í•¨ ìˆ«ì, ì˜ˆ: "15,600", "17,700")
            const priceMatch = text.match(/^(\d{1,3}(?:,\d{3})*)$/);
            if (priceMatch) {
              const price = parseInt(priceMatch[1].replace(/,/g, ''), 10);
              // ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ê°€ê²©ì„ íŒë§¤ê°€ë¡œ ì‚¬ìš©
              if (!salePrice) {
                salePrice = price;
              }
            }
          }

          // í• ì¸ìœ¨ì´ ìˆìœ¼ë©´ ì›ê°€ ê³„ì‚°
          if (discountRate && salePrice > 0) {
            originalPrice = Math.round(salePrice / (1 - discountRate / 100));
          }

          // ìƒí’ˆëª… ì¶”ì¶œ: productCardëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì°¾ì•˜ìœ¼ë¯€ë¡œ ì¬ì‚¬ìš©
          const paragraphs = Array.from(productCard.querySelectorAll('p'));
          let brandName = brand || '';
          let productNameText = '';

          // ì²« ë²ˆì§¸ë¡œ ë°œê²¬ë˜ëŠ” ê¸´ í…ìŠ¤íŠ¸ë¥¼ ìƒí’ˆëª…ìœ¼ë¡œ ê°„ì£¼
          // (í• ì¸ìœ¨, ê°€ê²©, "ì²«êµ¬ë§¤ í˜œíƒ" ë“±ì„ ì œì™¸)
          for (const p of paragraphs) {
            const text = p.textContent?.trim() || '';

            // ìˆ«ìë¡œ ì‹œì‘í•˜ê±°ë‚˜, %ê°€ í¬í•¨ë˜ê±°ë‚˜, ì½¤ë§ˆê°€ í¬í•¨ë˜ê±°ë‚˜, "ì²«êµ¬ë§¤", "êµ¬ë§¤ì¤‘" ë“±ì´ í¬í•¨ëœ í…ìŠ¤íŠ¸ëŠ” ìŠ¤í‚µ
            if (text.match(/^\d/) || text.includes('%') || text.match(/^[0-9,]+$/) ||
                text.includes('ì²«êµ¬ë§¤') || text.includes('êµ¬ë§¤ì¤‘') || text.includes('ê°œ êµ¬ë§¤')) {
              continue;
            }

            // ì§§ì€ í…ìŠ¤íŠ¸ëŠ” ë¸Œëœë“œëª…ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
            if (text.length <= 10) {
              continue;
            }

            // ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ê¸´ í…ìŠ¤íŠ¸ê°€ ìƒí’ˆëª…
            productNameText = text;
            break;
          }

          // í•„ìˆ˜ í•„ë“œ ê²€ì¦ (productIdì™€ productUrlì€ í•„ìˆ˜)
          if (!productId || !productUrl) {
            return;
          }

          // URL ì¤‘ë³µ ì²´í¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°í•œ ì •ê·œí™”ëœ URLë¡œ ë¹„êµ)
          const normalizedUrl = productUrl.split('?')[0];
          if (seenUrls.has(normalizedUrl)) {
            console.log('[Ably] ì¤‘ë³µ URL ì œê±°:', normalizedUrl);
            return;
          }
          seenUrls.add(normalizedUrl);

          results.push({
            productId: productId,
            brand: brandName,
            productName: productNameText || 'ìƒí’ˆëª… ì—†ìŒ',
            thumbnail: thumbnail,
            salePrice: salePrice,
            originalPrice: originalPrice,
            discountRate: discountRate,
            productUrl: productUrl,
          });
        } catch (error) {
          // ê°œë³„ ìƒí’ˆ íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ
          console.error('Ably ìƒí’ˆ íŒŒì‹± ì˜¤ë¥˜:', error);
        }
      });

      return results;
    })

  # evaluate ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬í•  ì¸ì
  scriptArgs:
    - "${brand}"
    - "${productName}"
    - "${context.productUrls}"  # ğŸ¯ clickAndExtractUrl ì•¡ì…˜ì—ì„œ ì €ì¥í•œ URL ë°°ì—´

  # í•„ë“œ ë§¤í•‘ (ë”ë¯¸, ì‹¤ì œë¡œëŠ” scriptì—ì„œ ì§ì ‘ ë°˜í™˜)
  fields:
    productId:
      selector: "dummy"
