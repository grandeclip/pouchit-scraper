mall: musinsa
name: "ë¬´ì‹ ì‚¬"
baseUrl: "https://www.musinsa.com"
searchUrl: "${baseUrl}/search/goods?keyword=${encodedQuery}&keywordType=keyword&gf=A"

# ìµœëŒ€ ê²°ê³¼ ìˆ˜ ì œí•œ
maxResults: 5

# ë¸Œë¼ìš°ì € ì„¤ì •
browser:
  headless: true
  args:
    - "--no-sandbox"
    - "--disable-setuid-sandbox"
    - "--disable-dev-shm-usage"
    - "--disable-accelerated-2d-canvas"
    - "--no-first-run"
    - "--no-zygote"
    - "--disable-gpu"
  viewport:
    width: 1920
    height: 1080
  # userAgentëŠ” config/userAgents/userAgents.yamlì—ì„œ ëœë¤ ì„ íƒë¨
  # í• ë‹¹ëœ User-Agents: chrome_mac_v120, chrome_mac_v131, chrome_win_v120, chrome_win_v131

# ë„¤ë¹„ê²Œì´ì…˜ ìˆœì„œ
navigation:
  steps:
    # 1. í™ˆí˜ì´ì§€ ì ‘ì† (ì„¸ì…˜ ì´ˆê¸°í™”)
    - action: goto
      url: "${baseUrl}"
      waitUntil: domcontentloaded
      timeout: 30000
    - action: wait
      duration: 2000

    # 2. ê²€ìƒ‰ í˜ì´ì§€ ì´ë™
    - action: goto
      url: "${searchUrl}"
      waitUntil: domcontentloaded
      timeout: 30000

    # 3. í˜ì´ì§€ ë¡œë”© ëŒ€ê¸° (CSR)
    - action: wait
      duration: 2000

    # ğŸ”¥ 4. ê²€ìƒ‰ ê²°ê³¼ ìˆìŒ/ì—†ìŒ Race (ë¹ ë¥¸ ê°ì§€)
    - action: waitForEither
      success:
        - 'a[href*="/products/"]'
        - 'img[alt*="ìƒí’ˆ"]'
      failure:
        - "text=/ê²€ìƒ‰.*ê²°ê³¼.*ì—†/"
        - "text=/ìƒí’ˆ.*ì—†/"
        - ".no-result"
        - ".empty-state"
      timeout: 5000
      onFailure: returnEmpty

    # 5. ë„¤íŠ¸ì›Œí¬ ì•ˆì •í™” ëŒ€ê¸° (optional) - ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    - action: waitForLoadState
      state: networkidle
      timeout: 10000
      optional: true

    # 6. ì¶”ê°€ ëŒ€ê¸° (ë™ì  ì½˜í…ì¸  ë¡œë”© ì™„ë£Œ)
    - action: wait
      duration: 2000

    # 7. ìŠ¤í¬ë¡¤ (lazy loading íŠ¸ë¦¬ê±°)
    - action: scroll
      x: 0
      y: 500
    - action: wait
      duration: 1500

# ë°ì´í„° ì¶”ì¶œ ê·œì¹™
extraction:
  type: evaluate
  script: |
    (function(brandName) {
      const results = [];
      const MAX_RESULTS = 5; // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ
      const productLinks = document.querySelectorAll('a[href*="/products/"]');
      const processedIds = new Set();
      const seenUrls = new Set(); // URL ì¤‘ë³µ ì²´í¬ìš©

      productLinks.forEach((link) => {
        // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
        if (results.length >= MAX_RESULTS) return;
        try {
          const href = link.getAttribute('href');
          if (!href) return;

          // ìƒí’ˆ ID ì¶”ì¶œ
          const productIdMatch = href.match(/\/products\/(\d+)/);
          if (!productIdMatch) return;

          const productId = productIdMatch[1];
          if (processedIds.has(productId)) return;
          processedIds.add(productId);

          // ìƒí’ˆ ì¹´ë“œ ì°¾ê¸° (ë¶€ëª¨ ìš”ì†Œ íƒìƒ‰)
          let card = link;
          let attempts = 0;
          while (card && attempts < 10) {
            const hasImage = card.querySelector('img') !== null;
            const hasText = (card.textContent || '').length > 10;

            if (hasImage && hasText) {
              break;
            }
            card = card.parentElement;
            attempts++;
          }

          if (!card) return;

          // ìƒí’ˆëª… ì¶”ì¶œ
          let productName = '';

          const linkText = link.textContent?.trim() || '';
          if (linkText && linkText.length > 3 && linkText.length < 200) {
            productName = linkText;
          }

          if (!productName) {
            const textElements = card.querySelectorAll('p, div, span');
            for (const el of Array.from(textElements)) {
              const text = el.textContent?.trim() || '';
              if (
                text.length > 10 &&
                text.length < 200 &&
                !text.includes('ì›') &&
                !text.includes('%')
              ) {
                productName = text;
                break;
              }
            }
          }

          if (!productName) return;

          // ë¸Œëœë“œëª… ì¶”ì¶œ
          let extractedBrand = brandName;
          const allText = card.textContent || '';
          const lines = allText
            .split('\n')
            .map((l) => l.trim())
            .filter((l) => l);

          for (const line of lines) {
            if (
              line.length > 0 &&
              line.length < 30 &&
              !line.includes('ì›') &&
              !line.includes('%') &&
              !line.includes('.') &&
              line !== productName
            ) {
              extractedBrand = line;
              break;
            }
          }

          // ê°€ê²© ì •ë³´ ì¶”ì¶œ
          let originalPrice = null;
          let salePrice = 0;
          let discountRate = null;

          const discountMatch = allText.match(/(\d+)%/);
          if (discountMatch) {
            discountRate = discountMatch[1] + '%';
          }

          const priceMatches = allText.match(/(\d{1,3}(?:,\d{3})+)ì›/g);
          if (priceMatches && priceMatches.length > 0) {
            const prices = priceMatches
              .map((p) => {
                const numStr = p.replace(/[^\d]/g, '');
                return parseInt(numStr, 10);
              })
              .filter((p) => p > 0);

            if (prices.length === 1) {
              salePrice = prices[0];
            } else if (prices.length >= 2) {
              originalPrice = Math.max(...prices);
              salePrice = Math.min(...prices);
            }
          }

          // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì¶”ì¶œ
          const imgElement = card.querySelector('img');
          let thumbnail = null;
          if (imgElement) {
            thumbnail =
              imgElement.getAttribute('src') || imgElement.getAttribute('data-src') || null;
            if (thumbnail) {
              thumbnail = thumbnail.split('?')[0];
            }
          }

          // ë¹ˆ ë¬¸ìì—´ì´ë©´ nullë¡œ ì„¤ì •
          if (thumbnail && thumbnail.trim() === '') {
            thumbnail = null;
          }

          // í‰ì  ì¶”ì¶œ
          let rating;
          const ratingMatch = allText.match(/(\d+\.\d+)/);
          if (ratingMatch) {
            rating = ratingMatch[1];
          }

          // ë¦¬ë·° ìˆ˜ ì¶”ì¶œ
          let reviewCount;
          const reviewMatch = allText.match(/\(([0-9,]+)\)/);
          if (reviewMatch) {
            reviewCount = reviewMatch[1].replace(/,/g, '');
          }

          const hasCoupon = allText.includes('ì¿ í°');
          const isExclusive = allText.includes('ë‹¨ë…');

          // URL ì •ê·œí™”: ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš° ê·¸ëŒ€ë¡œ, ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ë² ì´ìŠ¤ URL ì¶”ê°€
          let productUrl = href;
          if (href.startsWith('/')) {
            productUrl = 'https://www.musinsa.com' + href;
          } else if (!href.startsWith('http')) {
            productUrl = 'https://www.musinsa.com/' + href;
          }

          // URL ì¤‘ë³µ ì²´í¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°í•œ ì •ê·œí™”ëœ URLë¡œ ë¹„êµ)
          const normalizedUrl = productUrl.split('?')[0];
          if (seenUrls.has(normalizedUrl)) {
            console.log('[Musinsa] ì¤‘ë³µ URL ì œê±°:', normalizedUrl);
            return;
          }
          seenUrls.add(normalizedUrl);

          results.push({
            productId,
            productName,
            brand: extractedBrand,
            productUrl,
            thumbnail,
            originalPrice,
            salePrice,
            discountRate,
            rating,
            reviewCount,
            hasCoupon,
            isExclusive,
          });
        } catch {}
      });

      return results;
    })
  scriptArgs:
    - "${brand}"
  fields:
    productId:
      selector: "dummy"
