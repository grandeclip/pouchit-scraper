mall: kurly
name: "ì»¬ë¦¬"
baseUrl: "https://www.kurly.com"
searchUrl: "${baseUrl}/search?sword=${encodedQuery}&page=1"

# ìµœëŒ€ ê²°ê³¼ ìˆ˜ ì œí•œ
maxResults: 5

# ë¸Œë¼ìš°ì € ì„¤ì •
browser:
  headless: true
  args:
    - "--no-sandbox"
    - "--disable-setuid-sandbox"
    - "--disable-dev-shm-usage"
    - "--disable-accelerated-2d-canvas"
    - "--no-first-run"
    - "--no-zygote"
    - "--disable-gpu"
  viewport:
    width: 1920
    height: 1080
  # userAgentëŠ” config/userAgents/userAgents.yamlì—ì„œ ëœë¤ ì„ íƒë¨
  # í• ë‹¹ëœ User-Agents: chrome_mac_v120, chrome_mac_v131, chrome_win_v120, chrome_win_v131

# ë„¤ë¹„ê²Œì´ì…˜ ìˆœì„œ
navigation:
  steps:
    # 1. ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì§ì ‘ ì´ë™
    - action: goto
      url: "${searchUrl}"
      waitUntil: domcontentloaded
      timeout: 30000

    # ğŸ”¥ 2. ê²€ìƒ‰ ê²°ê³¼ ìˆìŒ/ì—†ìŒ Race (ë¹ ë¥¸ ê°ì§€)
    - action: waitForEither
      success:
        - 'a[href*="/goods/"]'
        - 'img[alt*="ìƒí’ˆ"]'
      failure:
        - "text=/ê²€ìƒ‰.*ê²°ê³¼.*ì—†/"
        - "text=/ìƒí’ˆ.*ì—†/"
        - ".no-result"
        - ".empty-state"
      timeout: 5000
      onFailure: returnEmpty

    # 3. ì´ë¯¸ì§€ lazy loading íŠ¸ë¦¬ê±° - ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    - action: scroll
      x: 0
      y: 400
    - action: wait
      duration: 500

    # 4. ìŠ¤í¬ë¡¤ ë³µê·€
    - action: scroll
      x: 0
      y: 0

    # 5. ì´ë¯¸ì§€ ë¡œë”© ëŒ€ê¸°
    - action: wait
      duration: 2000

# ë°ì´í„° ì¶”ì¶œ ê·œì¹™
extraction:
  type: evaluate
  script: |
    (function(brandName) {
      const results = [];
      const MAX_RESULTS = 5; // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ

      // main ìš”ì†Œ ë‚´ì˜ ìƒí’ˆ ë§í¬ ì°¾ê¸°
      const mainElement = document.querySelector('main');
      if (!mainElement) {
        return results;
      }

      const productLinks = mainElement.querySelectorAll('a[href*="/goods/"]');
      const processedIds = new Set();
      const seenUrls = new Set(); // URL ì¤‘ë³µ ì²´í¬ìš©

      productLinks.forEach((link) => {
        // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
        if (results.length >= MAX_RESULTS) return;
        try {
          const href = link.getAttribute('href');
          if (!href) return;

          // ìƒí’ˆ ID ì¶”ì¶œ
          const goodsNoMatch = href.match(/\/goods\/(\d+)/);
          if (!goodsNoMatch) return;

          const goodsNo = goodsNoMatch[1];
          if (processedIds.has(goodsNo)) return;
          processedIds.add(goodsNo);

          // ë§í¬ì˜ ìì‹ ìš”ì†Œ: [0] ì´ë¯¸ì§€ DIV, [1] ë‹´ê¸° ë²„íŠ¼, [2] ìƒí’ˆ ì •ë³´ DIV
          const children = Array.from(link.children);
          if (children.length < 3) return;

          // 1. ì´ë¯¸ì§€ ì¶”ì¶œ (ì²« ë²ˆì§¸ DIVì˜ img)
          let thumbnail = null;
          const imageDiv = children[0];
          const imgElement = imageDiv.querySelector('img');
          if (imgElement) {
            thumbnail = imgElement.src || null;
            if (thumbnail && thumbnail.includes('data:image/svg')) {
              thumbnail = null;
            }
          }

          // 2. ìƒí’ˆ ì •ë³´ DIV (ì„¸ ë²ˆì§¸ ìì‹)
          const infoDiv = children[2];
          const allText = infoDiv.textContent || '';

          // ìƒí’ˆ ì •ë³´ DIVì˜ ì§ê³„ ìì‹ë“¤
          const infoChildren = Array.from(infoDiv.children);

          let productName = '';
          let deliveryType = '';
          let description = '';
          let originalPrice = null;
          let salePrice = null;
          let discountRate = null;
          let reviewCount;
          let isKurlyOnly = false;

          // ì •ë³´ DIV ë‚´ë¶€ ìš”ì†Œ ìˆœíšŒ
          for (const child of infoChildren) {
            const text = child.textContent?.trim() || '';

            // ë°°ì†¡ íƒ€ì…
            if (text === 'ìƒ›ë³„ë°°ì†¡' || text === 'íƒë°°ë°°ì†¡') {
              deliveryType = text;
            }
            // ìƒí’ˆëª… (ëŒ€ê´„í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ê¸´ í…ìŠ¤íŠ¸)
            else if (text.startsWith('[') && text.length > 15 && !productName && !text.includes('ì›')) {
              productName = text;
            }
            // ì„¤ëª… (paragraph ìš”ì†Œ í¬í•¨)
            else if (child.querySelector('p') && text.length > 5 && text.length < 100) {
              const pElement = child.querySelector('p');
              if (pElement) {
                description = pElement.textContent?.trim() || '';
              }
            }
            // Kurly Only
            else if (text === 'Kurly Only') {
              isKurlyOnly = true;
            }
          }

          // ê°€ê²© ë° í• ì¸ìœ¨ ì •ë³´ëŠ” ì „ì²´ í…ìŠ¤íŠ¸ì—ì„œ ì¶”ì¶œ
          // í• ì¸ìœ¨ ì¶”ì¶œ (ìˆ«ì%)
          const discountMatch = allText.match(/(\d+)%/);
          if (discountMatch) {
            discountRate = parseInt(discountMatch[1]);
          }

          // ê°€ê²© ì¶”ì¶œ (ìˆ«ì,ìˆ«ìì› íŒ¨í„´)
          const priceMatches = allText.match(/(\d{1,3}(?:,\d{3})+)ì›/g);
          if (priceMatches && priceMatches.length > 0) {
            const prices = priceMatches
              .map((p) => {
                const numStr = p.replace(/[^\d]/g, '');
                return parseInt(numStr, 10);
              })
              .filter((p) => p > 0);

            if (prices.length === 1) {
              salePrice = prices[0];
            } else if (prices.length >= 2) {
              // ì²« ë²ˆì§¸ê°€ ì›ê°€, ë‘ ë²ˆì§¸ê°€ í• ì¸ê°€
              originalPrice = prices[0];
              salePrice = prices[1];
            }
          }

          // ë¦¬ë·° ìˆ˜ ì¶”ì¶œ (ì‘ì€ ìˆ«ìë§Œ, ê°€ê²©ì€ ì œì™¸)
          const reviewElement = infoDiv.querySelector('img[src*="icon"]');
          if (reviewElement && reviewElement.parentElement) {
            const reviewText = reviewElement.parentElement.textContent?.trim() || '';
            const reviewMatch = reviewText.match(/(\d+)/);
            if (reviewMatch) {
              const num = parseInt(reviewMatch[1]);
              if (num > 0 && num < 100000) {
                reviewCount = num;
              }
            }
          }

          // ë¸Œëœë“œëª… ì¶”ì¶œ (ëŒ€ê´„í˜¸ ì•ˆì˜ í…ìŠ¤íŠ¸)
          let extractedBrand = brandName;
          if (productName) {
            const brandMatch = productName.match(/^\[([^\]]+)\]/);
            if (brandMatch) {
              extractedBrand = brandMatch[1];
            }
          }

          // í•„ìˆ˜ í•„ë“œ í™•ì¸
          if (!productName) return;

          // URL ì •ê·œí™”: ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš° ê·¸ëŒ€ë¡œ, ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ë² ì´ìŠ¤ URL ì¶”ê°€
          let productUrl = href;
          if (href.startsWith('/')) {
            productUrl = 'https://www.kurly.com' + href;
          } else if (!href.startsWith('http')) {
            productUrl = 'https://www.kurly.com/' + href;
          }

          // URL ì¤‘ë³µ ì²´í¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°í•œ ì •ê·œí™”ëœ URLë¡œ ë¹„êµ)
          const normalizedUrl = productUrl.split('?')[0];
          if (seenUrls.has(normalizedUrl)) {
            console.log('[Kurly] ì¤‘ë³µ URL ì œê±°:', normalizedUrl);
            return;
          }
          seenUrls.add(normalizedUrl);

          results.push({
            productId: goodsNo,
            brand: extractedBrand,
            productName,
            productUrl,
            thumbnail,
            originalPrice,
            salePrice: salePrice || 0,
            discountRate,
            deliveryType,
            description,
            isKurlyOnly,
            reviewCount,
          });
        } catch {}
      });

      return results;
    })
  scriptArgs:
    - "${brand}"
  fields:
    productId:
      selector: "dummy"
