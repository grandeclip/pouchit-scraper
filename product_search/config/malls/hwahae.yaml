mall: hwahae
name: "í™”í•´"
baseUrl: "https://www.hwahae.co.kr"
searchUrl: "${baseUrl}/search?q=${encodedQuery}"

# ìµœëŒ€ ê²°ê³¼ ìˆ˜ ì œí•œ
maxResults: 5

# ë¸Œë¼ìš°ì € ì„¤ì •
browser:
  headless: true
  args:
    - --no-sandbox
    - --disable-setuid-sandbox
    - --disable-dev-shm-usage
    - --disable-accelerated-2d-canvas
    - --disable-gpu
    - --disable-blink-features=AutomationControlled
  viewport:
    width: 1920
    height: 1080
  # userAgentëŠ” config/userAgents/userAgents.yamlì—ì„œ ëœë¤ ì„ íƒë¨
  # í• ë‹¹ëœ User-Agents: chrome_mac_v131, chrome_win_v131, chrome_mac_v120, chrome_win_v120

# ë„¤ë¹„ê²Œì´ì…˜ ìˆœì„œ
navigation:
  steps:
    # 1. í™ˆí˜ì´ì§€ ì ‘ì† (ì„¸ì…˜ ì´ˆê¸°í™”)
    - action: goto
      url: "${baseUrl}"
      waitUntil: domcontentloaded
      timeout: 30000
    - action: wait
      duration: 2000
    
    # 2. ê²€ìƒ‰ í˜ì´ì§€ë¡œ ì´ë™
    - action: goto
      url: "${searchUrl}"
      waitUntil: domcontentloaded
      timeout: 30000
    
    # ğŸ”¥ 3. ê²€ìƒ‰ ê²°ê³¼ ìˆìŒ/ì—†ìŒ Race (ë¹ ë¥¸ ê°ì§€)
    - action: waitForEither
      success:
        - "h2"
        - 'a[href*="products/"]'
      failure:
        - "text=/ê²€ìƒ‰.*ê²°ê³¼.*ì—†/"
        - "text=/ìƒí’ˆ.*ì—†/"
        - "text=/ê²°ê³¼.*ì—†/"
        - ".no-result"
        - ".empty"
      timeout: 5000
      onFailure: returnEmpty

    # 4. ì¶”ê°€ ë¡œë”© ëŒ€ê¸° - ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    - action: wait
      duration: 2000

# ë°ì´í„° ì¶”ì¶œ ê·œì¹™
extraction:
  type: evaluate
  script: |
    (function(searchBrand) {
      const results = [];
      const MAX_RESULTS = 5; // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ
      const seenUrls = new Set(); // URL ì¤‘ë³µ ì²´í¬ìš©

      // "ì œí’ˆ" í—¤ë”© ì°¾ê¸°
      const headings = document.querySelectorAll('h2');
      let productHeading = null;

      for (const heading of headings) {
        if (heading.textContent && heading.textContent.includes('ì œí’ˆ')) {
          productHeading = heading;
          break;
        }
      }

      if (!productHeading) {
        return results;
      }

      // ì œí’ˆ ë¦¬ìŠ¤íŠ¸ ì°¾ê¸°
      const listContainer = productHeading.nextElementSibling;
      if (!listContainer) {
        return results;
      }

      const list = listContainer.querySelector('ul');
      if (!list) {
        return results;
      }

      const items = list.querySelectorAll('li');

      items.forEach((item) => {
        // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
        if (results.length >= MAX_RESULTS) return;
        try {
          const links = item.querySelectorAll('a');
          
          if (links.length >= 2) {
            // ì²« ë²ˆì§¸ ë§í¬: ì´ë¯¸ì§€
            const imgLink = links[0];
            const img = imgLink.querySelector('img');
            let thumbnail = img?.getAttribute('src') || '';
            
            // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°
            if (thumbnail) {
              thumbnail = thumbnail.split('?')[0];
            }
            
            // ë‘ ë²ˆì§¸ ë§í¬: ìƒí’ˆ ì •ë³´
            const infoLink = links[1];
            const href = infoLink.getAttribute('href') || '';
            const productId = href.replace('products/', '');
            
            // ìƒí’ˆëª…ê³¼ ë‹¨ì¢… ì—¬ë¶€
            const textDivs = infoLink.querySelectorAll('div');
            let productName = '';
            let isDiscontinued = false;
            
            if (textDivs.length > 0) {
              const firstDiv = textDivs[0];
              if (firstDiv.textContent?.trim() === 'ë‹¨ì¢…') {
                isDiscontinued = true;
                if (textDivs.length > 1) {
                  productName = textDivs[1].textContent?.trim() || '';
                }
              } else {
                productName = firstDiv.textContent?.trim() || '';
              }
            }
            
            // ë¸Œëœë“œëŠ” ê²€ìƒ‰ ì…ë ¥ê°’ ì‚¬ìš© (HTMLì— ì—†ìŒ)
            const brand = searchBrand;
            
            // í‰ì ê³¼ ë¦¬ë·° ìˆ˜
            const allText = infoLink.textContent || '';
            
            // í‰ì  ì¶”ì¶œ
            const ratingMatch = allText.match(/(\d+\.\d+)/);
            const rating = ratingMatch ? ratingMatch[1] : '';
            
            // ë¦¬ë·° ìˆ˜ ì¶”ì¶œ
            const reviewMatch = allText.match(/\(([0-9,]+)\)/);
            let reviewCount = '';
            if (reviewMatch) {
              reviewCount = reviewMatch[1];
            } else {
              const afterRating = allText.split(rating)[1];
              if (afterRating) {
                const numberMatch = afterRating.match(/([0-9,]+)/);
                if (numberMatch) {
                  reviewCount = numberMatch[1];
                }
              }
            }
            
            if (productName && productId) {
              const productUrl = 'https://www.hwahae.co.kr/products/' + productId;

              // URL ì¤‘ë³µ ì²´í¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°í•œ ì •ê·œí™”ëœ URLë¡œ ë¹„êµ)
              const normalizedUrl = productUrl.split('?')[0];
              if (seenUrls.has(normalizedUrl)) {
                console.log('[Hwahae] ì¤‘ë³µ URL ì œê±°:', normalizedUrl);
                return;
              }
              seenUrls.add(normalizedUrl);

              results.push({
                productId,
                brand,
                productName,
                isDiscontinued,
                thumbnail: thumbnail || null,
                rating,
                reviewCount,
                productUrl: productUrl,
                originalPrice: null,
                salePrice: 0,
              });
            }
          }
        } catch (error) {
          // ê°œë³„ ìƒí’ˆ íŒŒì‹± ì˜¤ë¥˜ ë¬´ì‹œ
        }
      });
      
      return results;
    })
  # evaluate ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬í•  ì¸ì
  scriptArgs:
    - "${brand}"
  
  # í•„ë“œ ë§¤í•‘ (ë”ë¯¸, ì‹¤ì œë¡œëŠ” scriptì—ì„œ ì§ì ‘ ë°˜í™˜)
  fields:
    productId:
      selector: "dummy"
