mall: coupang
name: "쿠팡"
baseUrl: "https://www.coupang.com"
searchUrl: "${baseUrl}/np/search?q=${encodedQuery}"

# 최대 결과 수 제한
maxResults: 5

# 브라우저 설정
browser:
  headless: true
  args:
    - "--no-sandbox"
    - "--disable-setuid-sandbox"
    - "--disable-blink-features=AutomationControlled"
    - "--disable-dev-shm-usage"
    - "--disable-accelerated-2d-canvas"
    - "--no-first-run"
    - "--no-zygote"
    - "--disable-gpu"
  viewport:
    width: 1920
    height: 1080
  # userAgent는 config/userAgents/userAgents.yaml에서 랜덤 선택됨
  # 할당된 User-Agents: chrome_mac_v133, chrome_win_v133, chrome_mac_v131, chrome_win_v131

# 네비게이션 순서
navigation:
  steps:
    # 1. 홈페이지 접속 (세션 초기화)
    - action: goto
      url: "${baseUrl}"
      waitUntil: domcontentloaded
      timeout: 30000
    - action: wait
      duration: 2000

    # 2. 검색 페이지 이동
    - action: goto
      url: "${searchUrl}"
      waitUntil: domcontentloaded
      timeout: 30000

    # 3. 상품 목록 대기
    - action: waitForSelector
      selector: 'a[href*="/vp/products/"]'
      timeout: 15000
      optional: true

    # 4. 추가 대기 (동적 콘텐츠 로딩)
    - action: wait
      duration: 5000

# 데이터 추출 규칙
extraction:
  type: evaluate
  script: |
    (function() {
      const results = [];
      const MAX_RESULTS = 5; // 최대 5개까지만
      const seenUrls = new Set(); // URL 중복 체크용

      // 검증된 선택자: 상품 링크
      const productLinks = document.querySelectorAll('a[href*="/vp/products/"]');

      productLinks.forEach((link) => {
        // 최대 개수 체크
        if (results.length >= MAX_RESULTS) return;
        try {
          const href = link.getAttribute('href');
          if (!href) return;
          
          // 상품 ID 추출
          const productIdMatch = href.match(/\/products\/(\d+)/);
          if (!productIdMatch) return;
          
          const productId = productIdMatch[1];
          
          // 상품명: 이미지 alt 속성 사용 (검증됨)
          const img = link.querySelector('img');
          const productName = img ? img.getAttribute('alt') : null;
          if (!productName) return;
          
          // 썸네일
          let thumbnail = img ? img.getAttribute('src') : null;
          if (thumbnail && !thumbnail.startsWith('http')) {
            thumbnail = 'https:' + thumbnail;
          }
          
          // 부모 요소에서 텍스트 정보 추출
          const parent = link.closest('li');
          if (!parent) return;
          
          const textContent = parent.textContent || '';
          
          // 가격 정보: 텍스트 패턴 매칭
          const priceMatches = textContent.match(/(\d{1,3}(?:,\d{3})*)\s*원/g);
          let salePrice = 0;
          let originalPrice = null;
          
          if (priceMatches && priceMatches.length > 0) {
            const prices = priceMatches.map(p => parseInt(p.replace(/[^0-9]/g, ''), 10));
            salePrice = Math.max(...prices);
            
            if (prices.length > 1) {
              originalPrice = Math.min(...prices.filter(p => p !== salePrice));
              if (originalPrice && originalPrice < salePrice) {
                originalPrice = null;
              }
            }
          }
          
          if (salePrice === 0) return;
          
          // 할인율
          const discountMatch = textContent.match(/(\d+)\s*%/);
          const discountRate = discountMatch ? parseInt(discountMatch[1], 10) : null;
          
          // 평점 및 리뷰: "5 (6817)" 패턴
          let rating = null;
          let reviewCount = null;
          const ratingMatch = textContent.match(/([1-5](?:\.\d)?)\s*\((\d{1,3}(?:,\d{3})*)\)/);
          if (ratingMatch) {
            rating = parseFloat(ratingMatch[1]);
            reviewCount = parseInt(ratingMatch[2].replace(/,/g, ''), 10);
          }
          
          // 브랜드: 상품명에서 추출
          const brandMatch = productName.match(/^([가-힣A-Za-z0-9\s]+?)\s/);
          const brand = brandMatch ? brandMatch[1].trim() : null;
          
          // 상품 URL 생성
          const productUrl = href.startsWith('http')
            ? href
            : 'https://www.coupang.com' + href;

          // URL 중복 체크 (쿼리 파라미터 제거한 정규화된 URL로 비교)
          const normalizedUrl = productUrl.split('?')[0];
          if (seenUrls.has(normalizedUrl)) {
            console.log('[Coupang] 중복 URL 제거:', normalizedUrl);
            return;
          }
          seenUrls.add(normalizedUrl);

          results.push({
            productId: productId,
            productName: productName,
            brand: brand,
            thumbnail: thumbnail,
            salePrice: salePrice,
            originalPrice: originalPrice,
            discountRate: discountRate,
            rating: rating,
            reviewCount: reviewCount,
            productUrl: productUrl,
          });
        } catch (error) {
          // 개별 상품 파싱 오류 무시
          console.error('쿠팡 상품 파싱 오류:', error);
        }
      });
      
      return results;
    })
  fields:
    productId:
      selector: "dummy"

