mall: zigzag
name: "ì§€ê·¸ì¬ê·¸"
baseUrl: "https://zigzag.kr"
searchUrl: "${baseUrl}/search?keyword=${encodedQuery}"

# ìµœëŒ€ ê²°ê³¼ ìˆ˜ ì œí•œ
maxResults: 5

# ë¸Œë¼ìš°ì € ì„¤ì •
browser:
  headless: true
  args:
    - "--no-sandbox"
    - "--disable-setuid-sandbox"
    - "--disable-dev-shm-usage"
    - "--disable-accelerated-2d-canvas"
    - "--no-first-run"
    - "--no-zygote"
    - "--disable-gpu"
  viewport:
    width: 1920
    height: 1080
  # userAgentëŠ” config/userAgents/userAgents.yamlì—ì„œ ëœë¤ ì„ íƒë¨
  # í• ë‹¹ëœ User-Agents: chrome_mac_simple, chrome_mac_v120, chrome_mac_v131, chrome_win_v120, chrome_win_v131

# ë„¤ë¹„ê²Œì´ì…˜ ìˆœì„œ
navigation:
  steps:
    # 1. ê²€ìƒ‰ URLë¡œ ì´ë™
    - action: goto
      url: "${searchUrl}"
      waitUntil: domcontentloaded
      timeout: 30000

    # 2. í˜ì´ì§€ ë¡œë”© ëŒ€ê¸°
    - action: wait
      duration: 2000

    # ğŸ”¥ 3. ê²€ìƒ‰ ê²°ê³¼ ìˆìŒ/ì—†ìŒ Race (ë¹ ë¥¸ ê°ì§€)
    - action: waitForEither
      success:
        - 'a[href^="/catalog/products/"]'
        - 'img[alt*="ìƒí’ˆ"]'
      failure:
        - "text=/ê²€ìƒ‰.*ê²°ê³¼.*ì—†/"
        - "text=/ìƒí’ˆ.*ì—†/"
        - ".no-result"
        - ".empty"
      timeout: 5000
      onFailure: returnEmpty

    # 4. ë„¤íŠ¸ì›Œí¬ idle ëŒ€ê¸° (optional) - ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
    - action: waitForLoadState
      state: networkidle
      timeout: 15000
      optional: true

    # 5. ìŠ¤í¬ë¡¤ (ì´ë¯¸ì§€ ë¡œë“œ íŠ¸ë¦¬ê±°)
    - action: scroll
      x: 0
      y: 500
    - action: wait
      duration: 2000

    # 6. ìŠ¤í¬ë¡¤ ë³µê·€
    - action: scroll
      x: 0
      y: 0
    - action: wait
      duration: 1000

# ë°ì´í„° ì¶”ì¶œ ê·œì¹™
extraction:
  type: evaluate
  script: |
    (function(brand) {
      const results = [];
      const MAX_RESULTS = 5; // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ
      const productLinks = document.querySelectorAll('a[href^="/catalog/products/"]');
      const processedIds = new Set();
      const seenUrls = new Set(); // URL ì¤‘ë³µ ì²´í¬ìš©

      productLinks.forEach((link) => {
        // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
        if (results.length >= MAX_RESULTS) return;
        try {
          const href = link.getAttribute('href');
          if (!href) return;

          const productId = href.replace('/catalog/products/', '');
          if (processedIds.has(productId)) return;
          processedIds.add(productId);

          // ìƒí’ˆ ì¹´ë“œ ì°¾ê¸° (ë¶€ëª¨ ìš”ì†Œ íƒìƒ‰)
          let card = link;
          let attempts = 0;
          while (card && attempts < 5) {
            if (card.querySelector('img') && (card.textContent || '').length > 20) {
              break;
            }
            card = card.parentElement;
            attempts++;
          }

          if (!card) return;

          // ì¸ë„¤ì¼
          const imgElement = card.querySelector('img[src*="cf.product-image.s.zigzag.kr"]');
          const thumbnail = imgElement?.getAttribute('src') || null;

          // ìƒí’ˆëª…
          const nameElements = card.querySelectorAll('p');
          let productName = '';
          for (const el of Array.from(nameElements)) {
            const text = el.textContent?.trim() || '';
            if (text.length > 5 && !text.includes('â‚©') && !text.includes('%')) {
              productName = text;
              break;
            }
          }
          if (!productName) return;

          // ê°€ê²© ì •ë³´
          const textContent = card.textContent || '';
          const priceMatch = textContent.match(/(\d{1,3}(?:,\d{3})*)\s*ì›/);
          const salePrice = priceMatch ? parseInt(priceMatch[1].replace(/,/g, ''), 10) : 0;

          // í• ì¸ìœ¨
          const discountMatch = textContent.match(/(\d+)%/);
          const discountRate = discountMatch ? parseInt(discountMatch[1], 10) : null;

          // ì›ê°€ ê³„ì‚°
          let originalPrice = null;
          if (discountRate && salePrice > 0) {
            originalPrice = Math.round(salePrice / (1 - discountRate / 100));
          }

          // í‰ì ê³¼ ë¦¬ë·° ìˆ˜
          const ratingMatch = textContent.match(/(\d\.\d)/);
          const rating = ratingMatch ? parseFloat(ratingMatch[1]) : null;

          const reviewMatch = textContent.match(/\(([0-9,]+)\)/);
          const reviewCount = reviewMatch ? parseInt(reviewMatch[1].replace(/,/g, ''), 10) : null;

          // ì¿ í° ì—¬ë¶€
          const hasCoupon = textContent.includes('ì¿ í°');

          // URL ì •ê·œí™”: ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš° ê·¸ëŒ€ë¡œ, ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ë² ì´ìŠ¤ URL ì¶”ê°€
          let productUrl = href;
          if (href.startsWith('/')) {
            productUrl = 'https://zigzag.kr' + href;
          } else if (!href.startsWith('http')) {
            productUrl = 'https://zigzag.kr/' + href;
          }

          // URL ì¤‘ë³µ ì²´í¬ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°í•œ ì •ê·œí™”ëœ URLë¡œ ë¹„êµ)
          const normalizedUrl = productUrl.split('?')[0];
          if (seenUrls.has(normalizedUrl)) {
            console.log('[Zigzag] ì¤‘ë³µ URL ì œê±°:', normalizedUrl);
            return;
          }
          seenUrls.add(normalizedUrl);

          results.push({
            productId,
            productName,
            brand,
            productUrl,
            thumbnail,
            salePrice,
            originalPrice,
            discountRate,
            rating,
            reviewCount,
            hasCoupon,
          });
        } catch {}
      });

      return results;
    })
  scriptArgs:
    - "${brand}"
  fields:
    productId:
      selector: "dummy"
