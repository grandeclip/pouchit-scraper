# Multi-Worker Queue System
# Phase 2: 플랫폼별 독립 Worker 컨테이너
#
# Browser 기반: oliveyoung, ably, kurly (각 4GB, shm_size 필요)
# API 기반: hwahae, musinsa, zigzag (각 2GB)
# Default: 기타 (2GB)

x-worker-common: &worker-common
  build:
    context: ..
    dockerfile: docker/Dockerfile.dev
  env_file:
    - ../.env.local
  volumes:
    - ../logs:/app/logs
    - ../results:/app/results
  depends_on:
    - redis
  command: npm run worker
  restart: unless-stopped
  stop_grace_period: 30s
  environment: &worker-env-common
    NODE_ENV: development
    REDIS_HOST: redis
    REDIS_PORT: "6379"
    WORKER_POLL_INTERVAL: "5000"
    TZ: Asia/Seoul
    LOG_LEVEL: info
    LOG_PRETTY: "true"
    LOG_DIR: /app/logs

x-browser-worker: &browser-worker
  <<: *worker-common
  shm_size: "2gb"
  deploy:
    resources:
      limits:
        memory: 4G

x-api-worker: &api-worker
  <<: *worker-common
  deploy:
    resources:
      limits:
        memory: 2G

services:
  # ============================================
  # API Server
  # ============================================
  product_scanner:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: product_scanner
    ports:
      - "3989:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - TZ=Asia/Seoul
      - SERVICE_NAME=server
      - LOG_LEVEL=info
      - LOG_PRETTY=true
      - LOG_DIR=/app/logs
    env_file:
      - ../.env.local
    volumes:
      - ../logs:/app/logs
      - ../results:/app/results
    depends_on:
      - redis
    command: npm run dev
    restart: unless-stopped
    stop_grace_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # Browser-based Workers (Playwright)
  # ============================================
  worker_oliveyoung:
    <<: *browser-worker
    container_name: worker_oliveyoung
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-oliveyoung
      WORKER_PLATFORMS: oliveyoung

  worker_ably:
    <<: *browser-worker
    container_name: worker_ably
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-ably
      WORKER_PLATFORMS: ably

  worker_kurly:
    <<: *browser-worker
    container_name: worker_kurly
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-kurly
      WORKER_PLATFORMS: kurly

  # ============================================
  # API-based Workers (HTTP/GraphQL)
  # ============================================
  worker_hwahae:
    <<: *api-worker
    container_name: worker_hwahae
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-hwahae
      WORKER_PLATFORMS: hwahae

  worker_musinsa:
    <<: *api-worker
    container_name: worker_musinsa
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-musinsa
      WORKER_PLATFORMS: musinsa

  worker_zigzag:
    <<: *api-worker
    container_name: worker_zigzag
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-zigzag
      WORKER_PLATFORMS: zigzag

  # ============================================
  # Default Worker (기타)
  # ============================================
  worker_default:
    <<: *api-worker
    container_name: worker_default
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-default
      WORKER_PLATFORMS: default

  # ============================================
  # Alert Worker (Alert Watcher 전용)
  # ============================================
  worker_alert:
    <<: *api-worker
    container_name: worker_alert
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-alert
      WORKER_PLATFORMS: alert

  # ============================================
  # Search Worker (상품 검색 전용 - Queue Consumer)
  # ============================================
  worker_search:
    <<: *browser-worker
    container_name: worker_search
    environment:
      <<: *worker-env-common
      SERVICE_NAME: worker-search
      # Search Worker 설정
      SEARCH_POLL_INTERVAL: "2000"
      SEARCH_CONCURRENCY: "3"
    command: npm run search-worker

  # ============================================
  # Scheduler (자동 Job 스케줄링)
  # ============================================
  scheduler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: scheduler
    env_file:
      - ../.env.local
    volumes:
      - ../logs:/app/logs
    depends_on:
      - redis
      - product_scanner
    command: npm run scheduler
    restart: unless-stopped
    stop_grace_period: 30s
    environment:
      NODE_ENV: development
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TZ: Asia/Seoul
      SERVICE_NAME: scheduler
      LOG_LEVEL: info
      LOG_PRETTY: "true"
      LOG_DIR: /app/logs
      # Scheduler 설정 (환경변수로 오버라이드 가능)
      SCHEDULER_PLATFORMS: hwahae,oliveyoung,zigzag,musinsa,ably,kurly
      SCHEDULER_CHECK_INTERVAL_MS: "10000"
      SCHEDULER_INTER_PLATFORM_DELAY_MS: "30000"
      SCHEDULER_SAME_PLATFORM_COOLDOWN_MS: "300000"
      SCHEDULER_ON_SALE_RATIO: "4"
      SCHEDULER_DEFAULT_LIMIT: "1000"
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================
  # Alert Watcher (테이블 모니터링 및 알림)
  # ============================================
  alert_watcher:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: alert_watcher
    env_file:
      - ../.env.local
    volumes:
      - ../logs:/app/logs
    depends_on:
      - redis
      - product_scanner
    command: npm run alert-watcher
    restart: unless-stopped
    stop_grace_period: 30s
    environment:
      NODE_ENV: development
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TZ: Asia/Seoul
      SERVICE_NAME: alert-watcher
      LOG_LEVEL: info
      LOG_PRETTY: "true"
      LOG_DIR: /app/logs
      # Alert Watcher 설정
      ALERT_WATCHER_RUN_ON_START: "false"
    deploy:
      resources:
        limits:
          memory: 256M

  # ============================================
  # Redis
  # ============================================
  redis:
    image: redis:8.2-alpine
    container_name: product_scanner_redis
    command: redis-server --appendonly no --maxmemory 1gb --maxmemory-policy allkeys-lru --save ""
    restart: unless-stopped
    stop_grace_period: 10s
    tmpfs:
      - /data
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============================================
  # Container Restarter (주기적 재시작 + Heartbeat 모니터링)
  # - 매일 04:10에 자동 재시작
  # - API 트리거: POST /api/v2/system/restart-all
  # - Heartbeat 실패 시 개별 컨테이너 재시작
  # ============================================
  restarter:
    image: docker:cli
    container_name: container_restarter
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - TZ=Asia/Seoul
      - RESTART_HOUR=04
      - RESTART_MINUTE=05
      - REDIS_CONTAINER=product_scanner_redis
      - TRIGGER_KEY=system:restart:trigger
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Alpine에서 TZ 환경변수 적용을 위해 tzdata 설치
        apk add --no-cache tzdata > /dev/null 2>&1

        echo "[Restarter] 시작"
        echo "  - Timezone: $${TZ}"
        echo "  - 현재 시간: $$(date)"
        echo "  - 스케줄: 매일 $${RESTART_HOUR}:$${RESTART_MINUTE}"
        echo "  - API 트리거: POST /api/v2/system/restart-all"
        echo "  - Heartbeat 모니터링: 60초 timeout"

        # 전체 순차 재시작
        do_restart() {
          echo "[$(date)] === 순차 재시작 시작 ==="

          # Phase 1: Redis
          echo "[$(date)] Phase 1: Redis 재시작"
          docker restart product_scanner_redis
          sleep 15

          # Phase 2: API Server
          echo "[$(date)] Phase 2: product_scanner 재시작"
          docker restart product_scanner
          sleep 30

          # Phase 3: Workers (순차)
          echo "[$(date)] Phase 3: Workers 재시작"
          for w in worker_oliveyoung worker_ably worker_kurly worker_search; do
            docker restart $$w && sleep 10
          done
          for w in worker_hwahae worker_musinsa worker_zigzag worker_default worker_alert; do
            docker restart $$w && sleep 5
          done

          # Phase 4: Scheduler & Alert
          echo "[$(date)] Phase 4: Scheduler, Alert 재시작"
          docker restart scheduler alert_watcher
          sleep 10

          # Phase 5: 서비스 재활성화 (product_scanner 내 curl 사용)
          echo "[$(date)] Phase 5: 서비스 재활성화"
          docker exec product_scanner curl -s -X POST "http://localhost:3000/api/v2/scheduler/start" || true
          docker exec product_scanner curl -s -X POST "http://localhost:3000/api/v2/alert-watcher/start" || true
          echo "[$(date)] 서비스 재활성화 완료"

          echo "[$(date)] === 순차 재시작 완료 ==="
        }

        # Heartbeat 체크 및 개별 재시작
        check_heartbeat() {
          local service=$$1
          local container=$$2
          local hb=$$(docker exec $${REDIS_CONTAINER} redis-cli GET "heartbeat:$${service}" 2>/dev/null)

          if [ -z "$$hb" ] || [ "$$hb" = "(nil)" ]; then
            echo "[$(date)] ⚠️ $${service} heartbeat 없음 - $${container} 재시작"
            docker restart $${container}
            sleep 30
            return 1
          fi
          return 0
        }

        while true; do
          # 1. API 트리거 확인 (Redis 폴링)
          trigger=$$(docker exec $${REDIS_CONTAINER} redis-cli GET $${TRIGGER_KEY} 2>/dev/null)
          if [ -n "$$trigger" ] && [ "$$trigger" != "(nil)" ]; then
            echo "[$(date)] API 트리거 감지: $$trigger"
            docker exec $${REDIS_CONTAINER} redis-cli DEL $${TRIGGER_KEY}
            do_restart
            sleep 120
            continue
          fi

          # 2. 스케줄 기반 재시작 확인
          current_hour=$$(date +%H)
          current_min=$$(date +%M)
          if [ "$$current_hour" = "$${RESTART_HOUR}" ] && [ "$$current_min" = "$${RESTART_MINUTE}" ]; then
            echo "[$(date)] 스케줄 트리거 (매일 $${RESTART_HOUR}:$${RESTART_MINUTE})"
            do_restart
            sleep 120
            continue
          fi

          # 3. Heartbeat 모니터링 (개별 재시작)
          check_heartbeat "worker:oliveyoung" "worker_oliveyoung"
          check_heartbeat "worker:ably" "worker_ably"
          check_heartbeat "worker:kurly" "worker_kurly"
          check_heartbeat "worker:search" "worker_search"
          check_heartbeat "worker:hwahae" "worker_hwahae"
          check_heartbeat "worker:musinsa" "worker_musinsa"
          check_heartbeat "worker:zigzag" "worker_zigzag"
          check_heartbeat "worker:default" "worker_default"
          check_heartbeat "worker:alert" "worker_alert"
          check_heartbeat "scheduler" "scheduler"
          check_heartbeat "alert_watcher" "alert_watcher"

          sleep 30
        done
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M
